<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eBarangay | Staff Login</title>
  <link rel="icon" type="image/jpeg" href="pics/eb-logo.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
</head>

<body class="login-page">

  <div id="loadingScreen">
    <div class="text-center">
      <img src="pics/eb-logo.jpg" alt="eBarangay Logo" style="max-width: 100px; height: auto; margin-bottom: 1.5rem;">
      <p class="small" style="color: rgba(255,255,255,0.9);">Please wait...</p>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg navbar-dark" style="background:linear-gradient(135deg, #781006, #9e0705, #b71c1c); margin-top: -8px; padding-top: 8px;">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="staff-login.html">
        <img src="pics/eb-logo.jpg" alt="eBarangay Logo" style="max-width: 40px; height: auto;">
        <span class="ms-2 text-light small">STAFF PORTAL</span>
      </a>
    </div>
  </nav>

  <section class="login-section d-flex align-items-center justify-content-center" style="min-height: 90vh;">
    <div class="login-card d-flex flex-md-row flex-column align-items-stretch mx-auto">
      <div class="login-left col-md-5">
        <i class="bi bi-shield-lock-fill"></i>
        <h4 class="fw-bold">Welcome Back</h4>
        <p class="small">Secure staff access to eBarangay services.<br>Login to continue.</p>
      </div>

      <div class="login-right col-md-7">
        <div class="mb-2 text-center" style="margin-top: 0.25rem;">
          <img src="pics/eb-logo.jpg" alt="eBarangay Logo" style="max-width: 90px; height: 70px;">
        </div>
        <h4 class="fw-bold mb-1 text-dark text-center">Staff Login</h4>
        <p class="text-muted mb-2 text-center small">Enter your credentials to access the console</p>

  <form id="staffLoginForm">
          <div class="mb-2">
            <label for="username" class="form-label fw-semibold small">Email Address</label>
            <input type="email" class="form-control form-control-sm" id="username" placeholder="Enter your email address" required>
            <div class="text-danger small mt-1" id="emailError" style="display: none; font-size: 0.7rem; min-height: 0;">
              Use a valid email (Gmail, Yahoo, Outlook, etc.)
            </div>
          </div>

          <div class="mb-2">
            <label for="password" class="form-label fw-semibold small">Password</label>
            <div class="password-wrapper">
              <input type="password" class="form-control form-control-sm" id="password" placeholder="Enter password" required>
              <i class="bi bi-eye-slash toggle-password" data-target="password"></i>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center">
              <input type="checkbox" id="rememberMe" class="me-2">
              <label for="rememberMe" class="small text-muted mb-0">Remember me</label>
            </div>
            <a href="#" class="small text-decoration-underline forgot-password-link" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
              Forgot Password?
            </a>
          </div>

          <button type="submit" class="btn w-100 reset-link-btn mt-1">Login</button>
        </form>

        <!-- Inline login status (success/error) -->
        <div id="loginMessage" class="alert small mt-2 d-none text-center mb-2 px-2 py-1"></div>

        <div class="mt-2 mb-2">
          <div class="alert alert-light border small text-center mb-0 px-2 py-1">
            <i class="bi bi-info-circle me-1 text-primary"></i> For authorized staff use only.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Forgot Password Modal -->
  <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header" style="background:linear-gradient(135deg, #c5202f, #222c8e, #6a0dad);">
          <h5 class="modal-title text-white fw-bold"><i class="bi bi-lock-fill me-2"></i> Forgot Password</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
              <div class="modal-body p-3">
                <form id="forgotPasswordForm">
                  <div class="mb-3">
                    <p class="small text-muted">Enter the email address associated with your staff account. If the email is registered, you will receive a password reset link.</p>
                    <label for="forgotEmail" class="form-label fw-semibold">Email Address</label>
                    <input type="email" class="form-control form-control-sm" id="forgotEmail" placeholder="Enter your registered email" required>
                  </div>
                  <button type="submit" class="btn w-100 reset-link-btn btn-sm mt-3">Send Reset Link</button>
                </form>
                <div id="forgotMessage" class="alert small mt-2 d-none text-center"></div>
              </div>
      </div>
    </div>
  </div>

  <!-- Change Password Prompt Modal (shown after login) -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Security Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small">For your account's security, please change your password before continuing. This helps protect your account and barangay data.</p>
          <p class="small mb-0 text-muted">You may choose to change it now or continue to the dashboard and change it later.</p>
        </div>
        <div class="modal-footer">
          <button id="changeNowBtn" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Change Password Now</button>
          <button id="continueBtn" type="button" class="btn btn-primary">Continue to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dedicated Change Password Modal -->
  <div class="modal fade" id="changeNowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div id="currentPasswordWrapper" class="mb-2" style="display:none;">
              <label class="form-label small fw-semibold">Current Password</label>
              <input type="password" id="currentPassword" class="form-control form-control-sm" placeholder="Enter current password">
              <div class="text-danger small mt-1 d-none" id="currentPasswordError">Current password is incorrect.</div>
            </div>

            <div class="mb-2">
              <label class="form-label small fw-semibold">New Password</label>
              <input type="password" id="newPassword" class="form-control form-control-sm" placeholder="Enter new password" required>
            </div>

            <div class="mb-2">
              <label class="form-label small fw-semibold">Confirm New Password</label>
              <input type="password" id="confirmPassword" class="form-control form-control-sm" placeholder="Confirm new password" required>
              <div class="text-danger small mt-1 d-none" id="confirmPasswordError">Passwords do not match.</div>
            </div>

            <div class="mb-2 small">
              <div>Password requirements:</div>
              <ul class="mb-0" id="pwRules">
                <li id="rule-length" class="text-muted">At least 8 characters</li>
                <li id="rule-upper" class="text-muted">Contains an uppercase letter (A-Z)</li>
                <li id="rule-lower" class="text-muted">Contains a lowercase letter (a-z)</li>
                <li id="rule-digit" class="text-muted">Contains a number (0-9)</li>
                <li id="rule-special" class="text-muted">Contains a special character (e.g. !@#$%)</li>
                <li id="rule-nospaces" class="text-muted">No spaces</li>
              </ul>
            </div>

            <div id="changeMsg" class="alert small d-none mt-2"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="cancelChangeBtn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="submitChangeBtn" type="button" class="btn btn-primary">Save New Password</button>
        </div>
      </div>
    </div>
  </div>

<!-- Footer -->
  <footer class="footer border-top py-3 bg-dark text-white mt-5">
    <div class="container">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
        <div class="d-flex align-items-center mb-2 mb-md-0">
          <img src="pics/eb-logo.jpg" alt="eBarangay Logo" class="me-2" style="max-width: 40px; height: auto;">
          <span class="fw-bold text-white">eBarangay</span>
          <span class="ms-2 text-white small">STAFF PORTAL</span>
        </div>
        <div class="small mb-2 mb-md-0" style="color: #070202 !important;">&copy; 2025 eBarangay. All rights reserved.</div>
        <div>
          <a href="#" class="text-decoration-none me-2 footer-link-dark" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a>
          <a href="#" class="text-decoration-none footer-link-dark" data-bs-toggle="modal" data-bs-target="#contactModal">Contact</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Privacy Policy Modal -->
  <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content rounded-4">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
          <p><strong>Introduction:</strong> This Privacy Policy explains how eBarangay collects, uses, and protects your personal information.</p>
          <p><strong>Information Collection:</strong> We may collect your name, email, address, phone number, and other information necessary to provide our services.</p>
          <p><strong>Use of Information:</strong> Your information will be used to process barangay documents, send notifications, and improve our services.</p>
          <p><strong>Data Protection:</strong> We implement reasonable administrative, physical, and technical safeguards to protect your information in accordance with the Data Privacy Act of 2025.</p>
          <p><strong>Sharing Information:</strong> We do not sell or share your personal information with third parties except as required by law or for official barangay services.</p>
          <p><strong>Cookies:</strong> We may use cookies to enhance user experience and track usage patterns.</p>
          <p><strong>Changes to Policy:</strong> We may update this policy from time to time. The updated version will be posted on this page.</p>
          <p><strong>Contact:</strong> For questions regarding this policy, contact us via the Contact modal.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content rounded-4">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="contactModalLabel">Contact Us</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="max-height: 50vh; overflow-y: auto;">
          <p><strong>Barangay eBarangay Office</strong></p>
          <p>123 Barangay St., City, Philippines</p>
          <p><strong>Email:</strong> <a href="https://mail.google.com/mail/?view=cm&fs=1&to=ebarangaypulongbuhangin@gmail.com&su=eBarangay%20Support%20Request" target="_blank" rel="noopener">ebarangaypulongbuhangin@gmail.com</a></p>
          <p><strong>Phone:</strong> +63 912 345 6789</p>
          <p><strong>Office Hours:</strong> Monday to Friday, 8:00 AM – 5:00 PM</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const loadingScreen = document.getElementById('loadingScreen');

    function showLoadingAndRedirect() {
      loadingScreen.classList.add('show');
      setTimeout(() => { window.location.href = "staff-dashboard.html"; }, 1500);
    }

    // Show security prompt after login: encourage users to change password
    // Accepts the logged-in email so the change flow can save password for that user
    function showChangePasswordPrompt(loggedEmail) {
      const modalEl = document.getElementById('changePasswordModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Wire buttons: Change Now opens the dedicated change-password modal
      document.getElementById('changeNowBtn').onclick = function() {
        modal.hide();
        setTimeout(() => {
          openChangePasswordModal(loggedEmail);
        }, 250);
      };

      // Continue proceeds to the dashboard with the loading screen
      document.getElementById('continueBtn').onclick = function() {
        modal.hide();
        showLoadingAndRedirect();
      };
    }

    // Open the dedicated change-password modal and wire form behavior for the supplied email
    function openChangePasswordModal(email) {
      const modalEl = document.getElementById('changeNowModal');
      const modal = new bootstrap.Modal(modalEl);

      // Check if a saved password exists for this email; if so, show current password field
      const savedPassword = localStorage.getItem('password_' + email);
      const currentWrapper = document.getElementById('currentPasswordWrapper');
      const currentInput = document.getElementById('currentPassword');
      const currentErr = document.getElementById('currentPasswordError');
      if (savedPassword) {
        currentWrapper.style.display = 'block';
      } else {
        currentWrapper.style.display = 'none';
        currentInput.value = '';
        currentErr.classList.add('d-none');
      }

      // Clear previous fields/messages
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('confirmPasswordError').classList.add('d-none');
      document.getElementById('changeMsg').className = 'alert small d-none mt-2';

      // Live-validate rules while typing
      const newPw = document.getElementById('newPassword');
      const confirmPw = document.getElementById('confirmPassword');
      function updateRules() {
        const val = newPw.value || '';
        const rules = {
          length: val.length >= 8,
          upper: /[A-Z]/.test(val),
          lower: /[a-z]/.test(val),
          digit: /[0-9]/.test(val),
          special: /[^A-Za-z0-9]/.test(val),
          nospaces: !/\s/.test(val)
        };
        document.getElementById('rule-length').className = rules.length ? 'text-success' : 'text-muted';
        document.getElementById('rule-upper').className = rules.upper ? 'text-success' : 'text-muted';
        document.getElementById('rule-lower').className = rules.lower ? 'text-success' : 'text-muted';
        document.getElementById('rule-digit').className = rules.digit ? 'text-success' : 'text-muted';
        document.getElementById('rule-special').className = rules.special ? 'text-success' : 'text-muted';
        document.getElementById('rule-nospaces').className = rules.nospaces ? 'text-success' : 'text-muted';
        return rules;
      }

      newPw.removeEventListener('input', updateRules);
      confirmPw.removeEventListener('input', onConfirmInput);
      newPw.addEventListener('input', updateRules);
      confirmPw.addEventListener('input', onConfirmInput);

      function onConfirmInput() {
        const a = newPw.value || '';
        const b = confirmPw.value || '';
        const err = document.getElementById('confirmPasswordError');
        if (b && a !== b) err.classList.remove('d-none'); else err.classList.add('d-none');
      }

      // Submit handler
      document.getElementById('submitChangeBtn').onclick = function() {
        const newVal = newPw.value || '';
        const conf = confirmPw.value || '';
        const rules = updateRules();
        const allPass = Object.values(rules).every(Boolean);
        if (!allPass) {
          const box = document.getElementById('changeMsg');
          box.className = 'alert alert-warning small mt-2';
          box.textContent = 'Password does not meet the requirements. Please follow the rules.';
          box.classList.remove('d-none');
          return;
        }
        if (newVal !== conf) {
          document.getElementById('confirmPasswordError').classList.remove('d-none');
          return;
        }

        // If saved password exists, verify current
        if (savedPassword) {
          const currentVal = currentInput.value || '';
          if (currentVal !== savedPassword) {
            currentErr.classList.remove('d-none');
            return;
          }
        }

        // Save new password and timestamp
        localStorage.setItem('password_' + email, newVal);
        localStorage.setItem('passwordChangedAt_' + email, new Date().toISOString());

        const box = document.getElementById('changeMsg');
        box.className = 'alert alert-success small mt-2';
        box.textContent = 'Password changed successfully. Redirecting...';
        box.classList.remove('d-none');

        setTimeout(() => {
          modal.hide();
          showLoadingAndRedirect();
        }, 900);
      };

      // Show modal
      modal.show();
    }

    document.getElementById("staffLoginForm").addEventListener("submit", async function (event) {
      event.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      const emailError = document.getElementById("emailError");
      const usernameInput = document.getElementById("username");
      const loginMessage = document.getElementById("loginMessage");

      if (!username || !password) {
        loginMessage.className = "alert alert-danger small mt-2 text-center mb-2 px-2 py-1";
        loginMessage.textContent = "Please enter both email and password.";
        loginMessage.classList.remove("d-none");
        return;
      }

      // Validate email format
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!emailRegex.test(username)) {
        usernameInput.style.borderColor = "#dc3545";
        emailError.style.display = "block";
        emailError.textContent = "Use a valid email format";
        return;
      }

      // Clear any error styling
      usernameInput.style.borderColor = "";
      emailError.style.display = "none";

      try {
        // Show loading state
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Logging in...";

        // Send login request to server
        const formData = new FormData();
        formData.append('email', username);
        formData.append('password', password);

        // Determine which login endpoint to use based on email
        const loginEndpoint = username === 'superadmin@gmail.com' ? 'admin_login.php' : 'staff_login.php';

        const response = await fetch(loginEndpoint, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          // Show success message
          loginMessage.className = "alert alert-success small mt-2 text-center mb-2 px-2 py-1";
          loginMessage.textContent = "Login successful! Redirecting...";
          loginMessage.classList.remove("d-none");

          // Store staff_id in sessionStorage for logout logging
          if (result.data.staff_id) {
            sessionStorage.setItem('staff_id', result.data.staff_id);
          }

          // Redirect based on role
          setTimeout(() => {
            if (result.data.role === 'superadmin') {
              window.location.href = 'super-admin.html';
            } else {
              window.location.href = 'staff-dashboard.html';
            }
          }, 1000);
        } else {
          // Show error message
          loginMessage.className = "alert alert-danger small mt-2 text-center mb-2 px-2 py-1";
          loginMessage.textContent = result.message || "Invalid email or password.";
          loginMessage.classList.remove("d-none");
          
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        }
      } catch (error) {
        console.error('Login error:', error);
        loginMessage.className = "alert alert-danger small mt-2 text-center mb-2 px-2 py-1";
        loginMessage.textContent = "Connection error. Please try again.";
        loginMessage.classList.remove("d-none");
        
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = "Login";
      }
    });

    // Clear error when user starts typing
    document.getElementById("username").addEventListener("input", function() {
      this.style.borderColor = "";
      document.getElementById("emailError").style.display = "none";
    });

    document.getElementById("forgotPasswordForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const forgotEmailInput = document.getElementById("forgotEmail");
      const forgotEmail = forgotEmailInput.value.trim();
      const messageBox = document.getElementById("forgotMessage");

      // basic validation
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      if (!forgotEmail || !emailRegex.test(forgotEmail)) {
        messageBox.className = "alert alert-warning small mt-2 text-center";
        messageBox.textContent = "Please enter a valid email address.";
        messageBox.classList.remove("d-none");
        return;
      }

      // NOTE: In a real app, you'd call your server endpoint here to send a reset email.
      // For now we display a neutral message and close the modal after a short delay.
      messageBox.className = "alert alert-success small mt-2 text-center";
      messageBox.textContent = "If an account with that email exists, a password reset link will be sent.";
      messageBox.classList.remove("d-none");

      setTimeout(() => {
        const modalEl = document.getElementById("forgotPasswordModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        // clear input
        forgotEmailInput.value = "";
      }, 1400);
    });

    // ✅ Show/Hide Password Toggle for all password fields
    document.querySelectorAll('.toggle-password').forEach(icon => {
      icon.addEventListener('click', () => {
        const target = document.getElementById(icon.getAttribute('data-target'));
        if (target.type === "password") {
          target.type = "text";
          icon.classList.replace('bi-eye-slash', 'bi-eye');
        } else {
          target.type = "password";
          icon.classList.replace('bi-eye', 'bi-eye-slash');
        }
      });
    });
  </script>
</body>
</html>

