<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>eBarangay | Staff Dashboard - Reports</title>
  <link rel="icon" type="image/jpeg" href="pics/eb-logo.jpg"> <!--FAVICON-->
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <style>
    /* Notification styles moved to style.css (centralized). */
    /* Filter button hover to match sidebar-residents gradient */
    #filterBtn {
      background-color: #4B0082; /* default solid purple */
      color: #fff;
      border: none;
    }
    #filterBtn:hover, #filterBtn:focus {
      background: linear-gradient(135deg, #6a0dad, #c5202f) !important;
      color: #fff !important;
      filter: brightness(0.98);
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(75, 0, 130, 0.12);
      outline: none;
    }
    .filter-refresh-btn {
      border: 2px solid #4B0082;
      color: #4B0082;
      border-radius: 50%;
      width: 38px;
      height: 38px;
      padding: 0;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s;
      box-shadow: none;
    }
    .filter-refresh-btn:hover,
    .filter-refresh-btn:focus,
    .filter-refresh-btn.filter-refresh-btn-loading {
      background: #4B0082 !important;
      color: #fff !important;
      box-shadow: 0 4px 12px rgba(106,13,173,0.10);
    }
    .filter-refresh-btn i {
      font-size: 1.25rem;
      transition: color 0.18s;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spin-animation { animation: spin 0.8s linear infinite; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="padding: 0.5rem 0; margin-top: -8px; padding-top: calc(0.5rem + 8px); z-index: 1050;">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="staff-dashboard.html">
        <img src="pics/eb-logo.jpg" alt="eBarangay Logo" class="me-2" style="height:40px; width:auto" />
        <span>STAFF DASHBOARD</span>
      </a>

      <div class="d-flex align-items-center position-relative">
        <!-- Notification Dropdown -->
        <div class="dropdown me-2">
          <button class="btn btn-light position-relative" id="notifButton" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            <i class="bi bi-bell fs-5"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifBadge">1</span>
          </button>

          <div class="dropdown-menu dropdown-menu-end shadow-sm p-0 border-0" id="notifDropdown" style="width:340px;">
            <div class="p-3 border-bottom bg-light">
              <h6 class="fw-bold mb-0">Notifications</h6>
            </div>

            <!-- Main notifications -->
            <div class="notification-panel">
              <div class="notif-item p-3 border-bottom unread">
                <div class="d-flex align-items-start">
                  <i class="bi bi-bell-fill me-2 text-primary fs-5"></i>
                  <div>
                    <h6 class="mb-1 fw-semibold text-dark">Document Request</h6>
                    <p class="mb-0 small text-secondary">Juan Dela Cruz requested a Barangay Clearance document.</p>
                  </div>
                </div>
              </div>

              <div class="notif-item p-3 border-bottom">
                <div class="d-flex align-items-start">
                  <i class="bi bi-file-earmark-text me-2 text-primary fs-5"></i>
                  <div>
                    <h6 class="mb-1 fw-semibold text-dark">Document Submitted</h6>
                    <p class="mb-0 small text-secondary">Donny Pangilinan submitted a Barangay Clearance request.</p>
                  </div>
                </div>
              </div>

              <div class="notif-item p-3 border-bottom">
                <div class="d-flex align-items-start">
                  <i class="bi bi-hourglass-split me-2 text-primary fs-5"></i>
                  <div>
                    <h6 class="mb-1 fw-semibold text-dark">Approval Pending</h6>
                    <p class="mb-0 small text-secondary">Waiting for approval of Maria Santos' Business Permit request.</p>
                  </div>
                </div>
              </div>

              <!-- Hidden extra notifications -->
              <div class="extra-notifs mt-0">
                <div class="notif-item p-3 border-bottom">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-calendar-event me-2 text-primary fs-5"></i>
                    <div>
                      <h6 class="mb-1 fw-semibold text-dark">Reminder</h6>
                      <p class="mb-0 small text-secondary">Barangay meeting scheduled for October 25.</p>
                    </div>
                  </div>
                </div>

                <div class="notif-item p-3 border-bottom">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-info-circle me-2 text-primary fs-5"></i>
                    <div>
                      <h6 class="mb-1 fw-semibold text-dark">System Update</h6>
                      <p class="mb-0 small text-secondary">New staff portal features have been added.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button class="btn btn-outline-light btn-sm" id="staffLogoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <!-- First Login Password Change Modal -->
  <div class="modal fade" id="firstLoginPasswordModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="firstLoginPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="firstLoginPasswordModalLabel">
            <i class="bi bi-shield-exclamation me-2"></i>Password Change Required
          </h5>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Security Notice:</strong> You are using the default password. For your account's security, you must change your password before continuing.
          </div>
          
          <form id="firstLoginPasswordForm">
            <div class="mb-3">
              <label for="firstLoginOldPassword" class="form-label fw-semibold">Old Password</label>
              <input type="password" class="form-control" id="firstLoginOldPassword" placeholder="Enter current password" required>
            </div>
            <div class="mb-3">
              <label for="firstLoginNewPassword" class="form-label fw-semibold">New Password</label>
              <input type="password" class="form-control" id="firstLoginNewPassword" placeholder="Enter new password" required>
            </div>
            
            <div class="mb-3">
              <label for="firstLoginConfirmPassword" class="form-label fw-semibold">Confirm New Password</label>
              <input type="password" class="form-control" id="firstLoginConfirmPassword" placeholder="Confirm new password" required>
            </div>

            <div class="small text-muted mb-3">
              <strong>Password requirements:</strong>
              <ul class="mb-0 mt-1">
                <li id="firstLogin-rule-length" class="text-muted">At least 8 characters</li>
                <li id="firstLogin-rule-uppercase" class="text-muted">Contains an uppercase letter (A-Z)</li>
                <li id="firstLogin-rule-lowercase" class="text-muted">Contains a lowercase letter (a-z)</li>
                <li id="firstLogin-rule-number" class="text-muted">Contains a number (0-9)</li>
                <li id="firstLogin-rule-special" class="text-muted">Contains a special character (!@#$%^&*)</li>
              </ul>
            </div>

            <div id="firstLoginPasswordError" class="alert alert-danger small d-none"></div>
            <div id="firstLoginPasswordSuccess" class="alert alert-success small d-none"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="firstLoginSubmitBtn">
            <i class="bi bi-check-circle me-1"></i>Change Password
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3 shadow-sm bg-light" style="position: fixed; top: 65px; left: 0; height: calc(100vh - 65px); overflow-y: auto; z-index: 1000;">
        <div class="nav flex-column">
          <a class="nav-link" href="staff-dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
          <a class="nav-link" href="sidebar-requests.php"><i class="bi bi-files me-2"></i> Requests</a>
          <a class="nav-link" href="sidebar-residents.php"><i class="bi bi-people me-2"></i> Residents</a>
          <a class="nav-link active" href="sidebar-reports.html"><i class="bi bi-clipboard-data me-2"></i> Reports</a>
          <a class="nav-link" href="sidebar-profile.html"><i class="bi bi-card-list me-2"></i> Profile</a>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="page-header mb-4">
          <h3>Reports</h3>
          <small>View and download barangay request reports by category, month, or year.</small>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div id="totalStatCard" class="stat-card bg-primary text-white text-center shadow-sm">
              <h5 id="reportsTotal">0</h5>
              <p>Total Requests</p>
            </div>
          </div>
          <div class="col-md-3">
            <div id="completedStatCard" class="stat-card bg-success text-white text-center shadow-sm">
              <h5 id="reportsCompleted">0</h5>
              <p>Completed</p>
            </div>
          </div>
          <div class="col-md-3">
            <div id="pendingStatCard" class="stat-card bg-warning text-dark text-center shadow-sm">
              <h5 id="reportsPending">0</h5>
              <p>Pending</p>
            </div>
          </div>
          <div class="col-md-3">
            <div id="cancelledStatCard" class="stat-card bg-danger text-white text-center shadow-sm">
              <h5 id="reportsCancelled">0</h5>
              <p>Cancelled</p>
            </div>
          </div>
        </div>

        <script>
          // Initialize popovers
          document.addEventListener('DOMContentLoaded', function() {
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            const popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
              return new bootstrap.Popover(popoverTriggerEl, {
                container: 'body',
                delay: { show: 100, hide: 100 }
              });
            });

            // Close popovers when clicking outside
            document.addEventListener('click', function(e) {
              if (!e.target.closest('[data-bs-toggle="popover"]')) {
                popoverList.forEach(popover => {
                  popover._element.blur();
                });
              }
            });
          });
        </script>

        <script>
          // Fetch request stats and update the top cards to reflect actual counts
          document.addEventListener('DOMContentLoaded', function () {
            // Notification handling
            const notifBadge = document.getElementById('notifBadge');
            const toggleExtraBtn = document.getElementById('toggleExtraNotifs');
            const extraNotifs = document.querySelector('.extra-notifs');

            // Get icon and color based on notification type
            function getNotificationIcon(type) {
              const icons = {
                'document_request': { icon: 'bi-file-earmark-text', color: 'text-primary' },
                'payment_sent': { icon: 'bi-credit-card', color: 'text-success' },
                'new_registration': { icon: 'bi-person-plus', color: 'text-info' },
                'profile_update': { icon: 'bi-pencil-square', color: 'text-warning' },
                'default': { icon: 'bi-bell-fill', color: 'text-primary' }
              };
              return icons[type] || icons['default'];
            }

            // Format time ago
            function timeAgo(dateString) {
              const date = new Date(dateString);
              const now = new Date();
              const seconds = Math.floor((now - date) / 1000);
              
              if (seconds < 60) return 'Just now';
              if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
              if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
              if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
              return date.toLocaleDateString();
            }

            async function fetchNotifications() {
              try {
                const res = await fetch('get_notifications.php', { cache: 'no-store' });
                const data = await res.json();
                const panel = document.querySelector('.notification-panel');
                if (!panel) return;
                
                panel.innerHTML = '';

                // Normalize response shape - handle both formats
                let notifs = [];
                let unreadCount = 0;
                
                if (data && data.success) {
                  notifs = data.data || [];
                  unreadCount = data.unread_count || 0;
                } else if (Array.isArray(data)) {
                  notifs = data;
                  unreadCount = data.filter(n => !n.is_read).length;
                }

                if (notifBadge) {
                  notifBadge.textContent = unreadCount;
                  notifBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
                }

                if (notifs.length === 0) {
                  panel.innerHTML = '<div class="p-3 text-center text-muted"><i class="bi bi-bell-slash me-2"></i>No notifications yet</div>';
                  return;
                }

                notifs.forEach(n => {
                  const item = document.createElement('div');
                  const isRead = Number(n.is_read ?? n.read ?? 0) === 1;
                  const iconInfo = getNotificationIcon(n.type || n.notification_type);
                  const timeStr = n.created_at ? timeAgo(n.created_at) : '';
                  
                  item.className = 'notif-item p-3 border-bottom' + (isRead ? '' : ' unread');
                  item.style.cursor = 'pointer';
                  item.innerHTML = `
                    <div class="d-flex align-items-start">
                      <i class="bi ${iconInfo.icon} me-2 ${iconInfo.color} fs-5"></i>
                      <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                          <h6 class="mb-1 fw-semibold text-dark" style="font-size: 0.9rem;">${escapeHtml(n.title || 'Notification')}</h6>
                          <small class="text-muted ms-2" style="white-space: nowrap;">${timeStr}</small>
                        </div>
                        <p class="mb-0 small text-secondary">${escapeHtml(n.message || '')}</p>
                      </div>
                    </div>
                  `;

                  item.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (!isRead) {
                      try {
                        await fetch('mark_notification_read.php', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ id: n.id })
                        });
                        item.classList.remove('unread');
                        const cur = parseInt(notifBadge.textContent || '0', 10);
                        if (cur > 0) {
                          notifBadge.textContent = cur - 1;
                          if (cur - 1 === 0) notifBadge.style.display = 'none';
                        }
                      } catch (err) {
                        console.error('mark read failed', err);
                      }
                    }
                  });

                  panel.appendChild(item);
                });
              } catch (err) {
                console.error('Failed to fetch notifications', err);
                const panel = document.querySelector('.notification-panel');
                if (panel) {
                  panel.innerHTML = '<div class="p-3 text-center text-muted"><i class="bi bi-exclamation-circle me-2"></i>Failed to load notifications</div>';
                }
              }
            }

            // Initial load and polling
            fetchNotifications();
            setInterval(fetchNotifications, 60000); // Poll every 1 minute

            if (toggleExtraBtn) {
              toggleExtraBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                if (extraNotifs) {
                  const isExpanded = extraNotifs.classList.contains('show');
                  extraNotifs.classList.toggle('show');
                  toggleExtraBtn.textContent = isExpanded
                    ? 'See Previous Notifications →'
                    : 'Hide Previous Notifications ↑';
                }
              });
            }

            // Reports stats fetching
            async function fetchStats(params = {}) {
              const qs = new URLSearchParams(params).toString();
              const url = 'get_request_stats.php' + (qs ? ('?' + qs) : '');
              const res = await fetch(url, { cache: 'no-store' });
              const raw = await res.json();
              return (raw && raw.success && raw.data) ? raw.data : raw;
            }

            function setText(id, value) {
              const el = document.getElementById(id);
              if (el) el.textContent = value;
            }

            function escapeHtml(str) {
              if (str === null || str === undefined) return '';
              return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            }

            function renderMostRequested(list) {
              const container = document.getElementById('mostRequestedContainer');
              if (!container) return;
              if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '';
                return;
              }
              let out = '';
              const items = list.slice(0, 4);
              items.forEach(item => {
                const name = escapeHtml(item.name ?? item.document_type ?? item[0] ?? 'Unknown');
                const count = Number(item.count ?? item.cnt ?? 0) || 0;
                out += `
                  <div class="col-md-3">
                    <div class="card shadow-sm p-3 text-center h-100">
                      <div class="small text-muted">${name}</div>
                      <div class="fw-bold fs-4 mt-2">${count}</div>
                    </div>
                  </div>
                `;
              });
              container.innerHTML = out;
            }

            function renderTableRows(rows) {
              const tbody = document.querySelector('#reportTable tbody');
              if (!tbody) return;
              if (!Array.isArray(rows) || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center small text-muted">No results</td></tr>';
                return;
              }
              let out = '';
              let idx = 1;
              for (const r of rows) {
                out += `<tr>` +
                  `<td>${idx}</td>` +
                  `<td>${escapeHtml(r.document_type ?? '')}</td>` +
                  `<td>${r.total ?? 0}</td>` +
                  `<td>${r.approved ?? 0}</td>` +
                  `<td>${r.pending ?? 0}</td>` +
                  `<td>${r.cancelled ?? 0}</td>` +
                  `<td>${escapeHtml(r.month ?? '')}</td>` +
                  `<td>${r.year ?? ''}</td>` +
                  `</tr>`;
                idx++;
              }
              tbody.innerHTML = out;
            }

            // Update only the global cards (ignore filters) so cards always show overall totals
            async function updateCardsGlobal() {
              try {
                const payload = await fetchStats();
                const total = payload.total ?? payload.total_requests ?? payload.count ?? 0;
                const completed = payload.completed ?? payload.approved ?? 0;
                const pending = payload.pending ?? 0;
                const cancelled = payload.rejected ?? payload.cancelled ?? 0;

                setText('reportsTotal', total);
                setText('reportsCompleted', completed);
                setText('reportsPending', pending);
                setText('reportsCancelled', cancelled);

                // Render most requested from global payload
                const most = payload.most_requested || payload.top_documents || payload.most_requested_documents || [];
                renderMostRequested(most);

                // Update the Total Requests popover with accurate findings
                try {
                  const el = document.getElementById('totalStatCard');
                  if (el) {
                    // Build popover content using the same category list as the Category select
                    let content = '<div class="small">';
                    content += '<strong>Request Breakdown:</strong><br><ul style="padding-left:18px;margin:6px 0;">';

                    // Gather category names from the select so order matches UI
                    const selectEl = document.getElementById('category');
                    const categoryNames = [];
                    if (selectEl && selectEl.options) {
                      for (let i = 0; i < selectEl.options.length; i++) {
                        const t = (selectEl.options[i].text || '').trim();
                        if (!t) continue;
                        // skip the generic All option
                        if (/^All/i.test(t)) continue;
                        categoryNames.push(t);
                      }
                    }

                    if (categoryNames.length) {
                      // For each category, find its count in most[]; show '-' when missing
                      categoryNames.forEach(name => {
                        const found = (Array.isArray(most) ? most.find(m => ((m.name || m.document_type || '').toString().trim() === name)) : null);
                        const cnt = found ? (Number(found.count ?? found.cnt ?? 0) || 0) : '-';
                        content += `<li>${escapeHtml(name)}: ${cnt}</li>`;
                      });
                    } else if (Array.isArray(most) && most.length) {
                      // Fallback: list items from most
                      most.forEach(it => {
                        const name = escapeHtml(it.name ?? it.document_type ?? 'Unknown');
                        const cnt = Number(it.count ?? it.cnt ?? 0) || 0;
                        content += `<li>${name}: ${cnt}</li>`;
                      });
                    } else {
                      content += '<li>No data available</li>';
                    }

                    content += '</ul>';
                    content += '<hr class="my-2"><em>Last 30 days activity</em>';
                    content += '</div>';

                    // Replace existing popover instance so content updates
                    const existing = bootstrap.Popover.getInstance(el);
                    if (existing) existing.dispose();
                    new bootstrap.Popover(el, {
                      container: 'body',
                      html: true,
                      content: content,
                      title: 'Total Document Requests',
                      trigger: 'hover focus',
                      placement: 'bottom',
                      delay: { show: 100, hide: 100 }
                    });
                  }
                } catch (pe) {
                  console.warn('Failed to update total card popover', pe);
                }

                // Completed card popover
                try {
                  const cel = document.getElementById('completedStatCard');
                  if (cel) {
                    const sr = payload.success_rate ?? (payload.completed && payload.total ? Math.round((payload.completed / payload.total) * 1000)/10 : 0);
                    const ct = payload.completed_time ?? {};
                    let ccontent = '<div class="small">';
                    ccontent += `<strong>Success Rate: ${escapeHtml(String(sr))}%</strong><br>`;
                    ccontent += '<ul style="padding-left:18px;margin:6px 0;">';
                    ccontent += `<li>Processed within 24h: ${escapeHtml(String(ct.within_24h ?? 0))}</li>`;
                    ccontent += `<li>Processed within 48h: ${escapeHtml(String(ct.within_48h ?? 0))}</li>`;
                    ccontent += `<li>Processed within 72h: ${escapeHtml(String(ct.within_72h ?? 0))}</li>`;
                    ccontent += '</ul>';
                    if (ct.avg_hours !== null && ct.avg_hours !== undefined && ct.avg_hours !== '') {
                      ccontent += '<hr class="my-2">';
                      ccontent += `<em>Average processing time: ${escapeHtml(String(ct.avg_hours))} hours</em>`;
                    }
                    ccontent += '</div>';

                    const existingC = bootstrap.Popover.getInstance(cel);
                    if (existingC) existingC.dispose();
                    new bootstrap.Popover(cel, { container: 'body', html: true, content: ccontent, title: 'Completed Requests', trigger: 'hover focus', placement: 'bottom', delay: { show: 100, hide: 100 } });
                  }
                } catch (pe) { console.warn('Completed popover update failed', pe); }

                // Pending card popover
                try {
                  const pel = document.getElementById('pendingStatCard');
                  if (pel) {
                    const pb = payload.pending_breakdown ?? {};
                    let pcontent = '<div class="small">';
                    pcontent += '<strong>Current Status:</strong><br>';
                    pcontent += '<ul style="padding-left:18px;margin:6px 0;">';
                    // If pending_breakdown has recognizable keys, list them, otherwise show generic
                    if (Object.keys(pb).length) {
                      for (const k of Object.keys(pb)) {
                        pcontent += `<li>${escapeHtml(k)}: ${escapeHtml(String(pb[k] ?? 0))}</li>`;
                      }
                    } else {
                      pcontent += '<li>No detailed breakdown available</li>';
                    }
                    pcontent += '</ul>';
                    if (payload.avg_pending_wait_hours) {
                      pcontent += '<hr class="my-2">';
                      pcontent += `<em>Average wait time: ${escapeHtml(String(payload.avg_pending_wait_hours))} hours</em>`;
                    }
                    pcontent += '</div>';

                    const existingP = bootstrap.Popover.getInstance(pel);
                    if (existingP) existingP.dispose();
                    new bootstrap.Popover(pel, { container: 'body', html: true, content: pcontent, title: 'Pending Requests', trigger: 'hover focus', placement: 'bottom', delay: { show: 100, hide: 100 } });
                  }
                } catch (pe) { console.warn('Pending popover update failed', pe); }

                // Cancelled card popover
                try {
                  const xal = document.getElementById('cancelledStatCard');
                  if (xal) {
                    const cr = payload.cancellation_reasons ?? {};
                    let xcontent = '<div class="small">';
                    xcontent += '<strong>Cancellation Reasons:</strong><br>';
                    xcontent += '<ul style="padding-left:18px;margin:6px 0;">';
                    if (Object.keys(cr).length) {
                      for (const k of Object.keys(cr)) {
                        xcontent += `<li>${escapeHtml(k)}: ${escapeHtml(String(cr[k] ?? 0))}</li>`;
                      }
                    } else {
                      xcontent += '<li>No cancellation reason data</li>';
                    }
                    xcontent += '</ul>';
                    if (payload.cancellation_rate !== null && payload.cancellation_rate !== undefined) {
                      xcontent += '<hr class="my-2">';
                      xcontent += `<em>Cancellation rate: ${escapeHtml(String(payload.cancellation_rate))}%</em>`;
                    }
                    xcontent += '</div>';

                    const existingX = bootstrap.Popover.getInstance(xal);
                    if (existingX) existingX.dispose();
                    new bootstrap.Popover(xal, { container: 'body', html: true, content: xcontent, title: 'Cancelled Requests', trigger: 'hover focus', placement: 'bottom', delay: { show: 100, hide: 100 } });
                  }
                } catch (pe) { console.warn('Cancelled popover update failed', pe); }
              } catch (err) {
                console.error('Failed to update global cards for reports page', err);
              }
            }

            // Update only the report table (respect filters)
            async function updateTable(params = {}) {
              try {
                const payload = await fetchStats(params);
                if (Array.isArray(payload.table_rows)) {
                  renderTableRows(payload.table_rows);
                } else {
                  // If server didn't return table_rows, try building from most_requested fallback
                  renderTableRows([]);
                }
              } catch (err) {
                console.error('Failed to fetch report table', err);
              }
            }

            // initial load: populate global cards and table (unfiltered)
            updateCardsGlobal();
            updateTable();

            // Wire dropdowns to auto-filter table on change
            const category = document.getElementById('category');
            const month = document.getElementById('month');
            const year = document.getElementById('year');
            
            if (category) {
              category.addEventListener('change', function () {
                const params = {};
                if (this.value && this.value !== 'All') params.category = this.value;
                if (month && month.value && month.value !== 'All' && month.value !== 'All Months') params.month = month.value;
                if (year && year.value && year.value !== 'All') params.year = year.value;
                updateTable(params);
              });
            }
            
            if (month) {
              month.addEventListener('change', function () {
                const params = {};
                if (category && category.value && category.value !== 'All') params.category = category.value;
                if (this.value && this.value !== 'All' && this.value !== 'All Months') params.month = this.value;
                if (year && year.value && year.value !== 'All') params.year = year.value;
                updateTable(params);
              });
            }
            
            if (year) {
              year.addEventListener('change', function () {
                const params = {};
                if (category && category.value && category.value !== 'All') params.category = category.value;
                if (month && month.value && month.value !== 'All' && month.value !== 'All Months') params.month = month.value;
                if (this.value && this.value !== 'All') params.year = this.value;
                updateTable(params);
              });
            }

            // Refresh button: reset filters and reload table + cards
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
              refreshBtn.addEventListener('click', function () {
                const icon = refreshBtn.querySelector('i');
                refreshBtn.classList.add('filter-refresh-btn-loading');
                icon.classList.add('spin-animation');
                refreshBtn.disabled = true;
                // reset selects to defaults
                const cat = document.getElementById('category');
                const mon = document.getElementById('month');
                const yr = document.getElementById('year');
                if (cat) cat.value = 'All';
                if (mon) mon.value = 'All';
                if (yr) yr.value = 'All';
                // refresh both the table and the global cards
                updateTable();
                updateCardsGlobal();
                setTimeout(() => {
                  icon.classList.remove('spin-animation');
                  refreshBtn.classList.remove('filter-refresh-btn-loading');
                  refreshBtn.disabled = false;
                }, 800);
              });
            }
    <!-- style removed: now using .filter-refresh-btn from global style -->

            // Refresh global cards every 60 seconds while on page
            setInterval(() => updateCardsGlobal(), 60000);
          });
        </script>

        <!-- Filter Section -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <form class="row g-3 align-items-center">
              <div class="col-md-4">
                <select id="category" class="form-select">
                  <option value="All">All Categories</option>
                  <option>Barangay Clearance</option>
                  <option>Certificate of Residency</option>
                  <option>Certificate of Indigency</option>
                  <option>Certificate of Good Moral Character</option>
                  <option>Business Clearance / Permit</option>
                  <option>Certificate of Solo Parent</option>
                <option>Certificate of No Derogatory Record</option>
                <option>Blotter / Incident Report</option>
                <option>Barangay ID</option>
                <option>Certificate of Low Income</option>
                <option>Certificate of Non-Employment</option>
                <option>Certificate for Burial Assistance</option>
                <option>Other (Please Specify)</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="month" class="form-select">
                <option value="All">All Months</option>
                <option>January</option><option>February</option><option>March</option>
                <option>April</option><option>May</option><option>June</option>
                <option>July</option><option>August</option><option>September</option>
                <option>October</option><option>November</option><option>December</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="year" class="form-select">
                <option value="All">All Years</option>
                <option>2025</option>
                <option>2026</option>
                <option>Archived</option>
              </select>
            </div>
            <div class="col-md-auto d-flex align-items-center" style="height: 100%;">
              <button type="button" id="refreshBtn" class="filter-refresh-btn d-flex align-items-center justify-content-center ms-2" title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
              </button>
            </div>
            </form>
          </div>
        </div>        <!-- Reports Table -->
        <div class="report-table p-4 mb-4 border rounded bg-white shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold">Report Results</h5>
            <button id="downloadBtn" class="btn btn-success btn-sm">
              <i class="bi bi-download me-1"></i> Download Report
            </button>
          </div>

          <div class="table-responsive">
            <table class="table table-striped align-middle" id="reportTable">
              <thead class="table-primary">
                <tr>
                  <th>#</th>
                  <th>Document Type</th>
                  <th>Total Requests</th>
                  <th>Approved</th>
                  <th>Pending</th>
                  <th>Cancelled</th>
                  <th>Month</th>
                  <th>Year</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td><td>Barangay Clearance</td><td>35</td><td>33</td><td>2</td><td>0</td><td>September</td><td>2025</td>
                </tr>
                <tr>
                  <td>2</td><td>Certificate of Indigency</td><td>28</td><td>26</td><td>2</td><td>0</td><td>September</td><td>2025</td>
                </tr>
                <tr>
                  <td>3</td><td>Residency Certificate</td><td>22</td><td>21</td><td>1</td><td>0</td><td>September</td><td>2025</td>
                </tr>
                <tr>
                  <td>4</td><td>Business Permit</td><td>18</td><td>15</td><td>2</td><td>1</td><td>August</td><td>2025</td>
                </tr>
                <tr>
                  <td>5</td><td>Barangay Clearance</td><td>42</td><td>40</td><td>2</td><td>0</td><td>January</td><td>2026</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

 <!-- ===== Stylish Report Details Modal ===== -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content border-0 shadow-lg rounded-4">

      <!-- Header -->
      <div class="modal-header text-white rounded-top-4"
           style="background: linear-gradient(135deg, #c5202f, #222c8e, #6a0dad);">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-file-text me-2"></i> Report Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body p-4">
        <!-- Document Card -->
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <div class="fw-semibold small text-muted mb-1">Document</div>
            <div id="modal-doc" class="fw-bold fs-6">—</div>
          </div>
        </div>

        <!-- Month & Year Card -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold small text-muted mb-1">Month</div>
                <div id="modal-month" class="fw-bold fs-6">—</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold small text-muted mb-1">Year</div>
                <div id="modal-year" class="fw-bold fs-6">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Requests Card -->
        <div class="card border-0 shadow-sm">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div class="fw-semibold small text-muted">Total Requests</div>
            <span id="modal-total" class="badge rounded-pill px-3 py-2 fs-6 bg-success text-white">
              0
            </span>
          </div>
        </div>
      </div>

      <!-- Footer (footer-level dismiss removed; use header close) -->
      <div class="modal-footer border-0">
        <!-- footer close removed to keep only header X for dismissing this modal -->
      </div>
    </div>
  </div>
</div>


  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- xlsx-js-style library for Excel export WITH styling support -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <!-- Filter functionality -->
  <script src="filter.js"></script>

  <!-- JS: Download & view wiring (filtering handled in filter.js) -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const downloadBtn = document.getElementById('downloadBtn');
      const table = document.getElementById('reportTable');
      const tbody = table.querySelector('tbody');

      // Download Function (Excel Export with Professional Formatting & Borders)
      if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
          const headerCols = Array.from(table.querySelectorAll('thead th'))
            .map(th => th.innerText.trim());

          const visibleRows = Array.from(tbody.querySelectorAll('tr'))
            .filter(row => row.style.display !== 'none' && !(row.id && row.id.includes('no-results')));

          if (visibleRows.length === 0) {
            alert('No data to export. Please adjust your filters.');
            return;
          }

          // Prepare data array for Excel with title rows
          const timestamp = new Date();
          const dateStr = timestamp.toLocaleDateString('en-PH', { year: 'numeric', month: 'long', day: 'numeric' });
          
          const data = [
            ['eBarangay Document Request Report'], // Title row
            ['Pulong Buhangin, Sta. Maria, Bulacan'], // Subtitle row
            [`Report Generated: ${dateStr}`], // Date row
            [], // Empty row for spacing
            headerCols // Column headers
          ];
          
          visibleRows.forEach(row => {
            const cols = Array.from(row.cells).map(td => td.innerText.trim());
            data.push(cols);
          });

          // Calculate totals for numeric columns
          let totalRequests = 0, totalApproved = 0, totalPending = 0, totalCancelled = 0;
          for (let i = 5; i < data.length; i++) {
            totalRequests += parseInt(data[i][2]) || 0;
            totalApproved += parseInt(data[i][3]) || 0;
            totalPending += parseInt(data[i][4]) || 0;
            totalCancelled += parseInt(data[i][5]) || 0;
          }
          
          // Add total row
          data.push(['TOTAL', '', totalRequests, totalApproved, totalPending, totalCancelled, '', '']);

          // Create workbook and worksheet
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet(data);

          // Merge cells for title rows
          ws['!merges'] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: headerCols.length - 1 } }, // Title
            { s: { r: 1, c: 0 }, e: { r: 1, c: headerCols.length - 1 } }, // Subtitle
            { s: { r: 2, c: 0 }, e: { r: 2, c: headerCols.length - 1 } }  // Date
          ];

          // Calculate column widths
          const colWidths = headerCols.map((header, i) => {
            const maxLength = Math.max(
              header.length,
              ...data.slice(5).map(row => String(row[i] || '').length)
            );
            return { wch: Math.min(Math.max(maxLength + 4, 12), 40) };
          });
          ws['!cols'] = colWidths;

          // Set row heights
          ws['!rows'] = [
            { hpx: 40 }, // Title row
            { hpx: 28 }, // Subtitle row
            { hpx: 24 }, // Date row
            { hpx: 12 }, // Empty row
            { hpx: 35 }, // Header row
            ...data.slice(5).map(() => ({ hpx: 28 })) // Data rows
          ];

          // Define border styles
          const thinBorder = {
            top: { style: 'thin', color: { rgb: '000000' } },
            bottom: { style: 'thin', color: { rgb: '000000' } },
            left: { style: 'thin', color: { rgb: '000000' } },
            right: { style: 'thin', color: { rgb: '000000' } }
          };

          const mediumBorder = {
            top: { style: 'medium', color: { rgb: '000000' } },
            bottom: { style: 'medium', color: { rgb: '000000' } },
            left: { style: 'medium', color: { rgb: '000000' } },
            right: { style: 'medium', color: { rgb: '000000' } }
          };

          // Apply styling to all cells
          const range = XLSX.utils.decode_range(ws['!ref']);
          const totalRowIndex = data.length - 1;
          
          for (let R = range.s.r; R <= range.e.r; R++) {
            for (let C = range.s.c; C <= range.e.c; C++) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: '' };
              
              // Title row (row 0)
              if (R === 0) {
                ws[cellAddress].s = {
                  font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 18, name: 'Calibri' },
                  fill: { fgColor: { rgb: '4B0082' }, patternType: 'solid' },
                  alignment: { horizontal: 'center', vertical: 'center' },
                  border: mediumBorder
                };
              }
              // Subtitle row (row 1)
              else if (R === 1) {
                ws[cellAddress].s = {
                  font: { bold: true, sz: 12, color: { rgb: '333333' }, name: 'Calibri' },
                  fill: { fgColor: { rgb: 'E8E0F0' }, patternType: 'solid' },
                  alignment: { horizontal: 'center', vertical: 'center' },
                  border: thinBorder
                };
              }
              // Date row (row 2)
              else if (R === 2) {
                ws[cellAddress].s = {
                  font: { italic: true, sz: 11, color: { rgb: '555555' }, name: 'Calibri' },
                  fill: { fgColor: { rgb: 'F5F0FA' }, patternType: 'solid' },
                  alignment: { horizontal: 'center', vertical: 'center' },
                  border: thinBorder
                };
              }
              // Empty row (row 3)
              else if (R === 3) {
                ws[cellAddress].s = {
                  border: thinBorder
                };
              }
              // Header row (row 4)
              else if (R === 4) {
                ws[cellAddress].s = {
                  font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 12, name: 'Calibri' },
                  fill: { fgColor: { rgb: '6A0DAD' }, patternType: 'solid' },
                  alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                  border: mediumBorder
                };
              }
              // Total row (last row)
              else if (R === totalRowIndex) {
                ws[cellAddress].s = {
                  font: { bold: true, color: { rgb: 'FFFFFF' }, sz: 12, name: 'Calibri' },
                  fill: { fgColor: { rgb: 'C5202F' }, patternType: 'solid' },
                  alignment: { horizontal: 'center', vertical: 'center' },
                  border: mediumBorder
                };
              }
              // Data rows
              else if (R > 4) {
                const isEvenRow = (R - 5) % 2 === 0;
                const numericColumns = [0, 2, 3, 4, 5]; // #, Total Requests, Approved, Pending, Cancelled
                
                ws[cellAddress].s = {
                  font: { sz: 11, name: 'Calibri' },
                  fill: { fgColor: { rgb: isEvenRow ? 'F8F4FC' : 'FFFFFF' }, patternType: 'solid' },
                  alignment: { 
                    horizontal: numericColumns.includes(C) ? 'center' : 'left', 
                    vertical: 'center' 
                  },
                  border: thinBorder
                };
              }
            }
          }

          // Add worksheet to workbook
          XLSX.utils.book_append_sheet(wb, ws, 'Document Report');

          // Generate Excel file with timestamp
          const fileTimestamp = timestamp.toISOString().split('T')[0];
          const timeStr = timestamp.toTimeString().split(' ')[0].replace(/:/g, '-');
          const fileName = `eBarangay_Report_${fileTimestamp}_${timeStr}.xlsx`;
          
          XLSX.writeFile(wb, fileName);
        });
      }

      // Wire View buttons to populate modal
      document.querySelectorAll('.view-report').forEach(btn => {
        btn.addEventListener('click', function () {
          const get = (k) => this.getAttribute(k) || '';
          document.getElementById('modal-doc').textContent = get('data-doc');
          document.getElementById('modal-month').textContent = get('data-month');
          document.getElementById('modal-year').textContent = get('data-year');
          document.getElementById('modal-total').textContent = get('data-total');
        });
      });
    });
  </script>
  <!-- Notification Modal (shared) -->
  <div class="modal fade" id="notifModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="notifModalLabel">Notification</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="notifModalBody">Details</div>
        <div class="modal-footer">
          <a id="notifViewBtn" class="btn btn-primary" href="#">View</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Persist page DOM notifications into central localStorage so other pages (Settings) can read them -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      try {
        const STORAGE_KEY = 'eb_notifications_v1';
        const raw = localStorage.getItem(STORAGE_KEY);
        const stored = raw ? JSON.parse(raw) : [];
        const els = Array.from(document.querySelectorAll('.notif-item'));
        const base = Date.now();
        els.forEach((el, idx) => {
          const obj = {
            id: el.getAttribute('data-id') || `n-${base}-${idx}`,
            title: el.getAttribute('data-title') || el.querySelector('h6')?.textContent || 'Notification',
            message: el.getAttribute('data-message') || el.querySelector('p')?.textContent || '',
            url: el.getAttribute('data-url') || '#',
            unread: el.classList.contains('unread'),
            iconClass: el.querySelector('i') ? Array.from(el.querySelector('i').classList).join(' ') : 'bi bi-bell-fill'
          };
          const exists = stored.some(u => (u.id && obj.id && u.id === obj.id) || (u.title === obj.title && u.message === obj.message && u.url === obj.url));
          if (!exists) stored.push(obj);
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stored));
      } catch (e) { /* ignore */ }
    });

    // Check if staff needs to change default password
    async function checkDefaultPassword() {
      try {
        const response = await fetch('check_default_password.php', {
          method: 'GET',
          cache: 'no-store'
        });
        
        const result = await response.json();
        
        if (result.success && result.isDefaultPassword) {
          const modal = new bootstrap.Modal(document.getElementById('firstLoginPasswordModal'));
          modal.show();
        }
      } catch (error) {
        console.error('Error checking default password:', error);
      }
    }

    function validateFirstLoginPassword(password) {
      const rules = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };
      
      document.getElementById('firstLogin-rule-length').className = rules.length ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-uppercase').className = rules.uppercase ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-lowercase').className = rules.lowercase ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-number').className = rules.number ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-special').className = rules.special ? 'text-success' : 'text-muted';
      
      return Object.values(rules).every(Boolean);
    }

    document.getElementById('firstLoginNewPassword')?.addEventListener('input', function() {
      if (this.value) {
        validateFirstLoginPassword(this.value);
      }
    });

    document.getElementById('firstLoginSubmitBtn')?.addEventListener('click', async function() {
      const oldPassword = document.getElementById('firstLoginOldPassword').value;
      const newPassword = document.getElementById('firstLoginNewPassword').value;
      const confirmPassword = document.getElementById('firstLoginConfirmPassword').value;
      const errorDiv = document.getElementById('firstLoginPasswordError');
      const successDiv = document.getElementById('firstLoginPasswordSuccess');
      const submitBtn = this;

      errorDiv.classList.add('d-none');
      successDiv.classList.add('d-none');

      if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.remove('d-none');
        return;
      }

      if (!oldPassword) {
        errorDiv.textContent = 'Current password is required';
        errorDiv.classList.remove('d-none');
        return;
      }

      if (!validateFirstLoginPassword(newPassword)) {
        errorDiv.textContent = 'Password does not meet all requirements';
        errorDiv.classList.remove('d-none');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Changing...';

        const formData = new FormData();
        formData.append('old_password', oldPassword);
        formData.append('new_password', newPassword);

        const response = await fetch('change_first_login_password.php', {
          method: 'POST',
          body: formData,
          cache: 'no-store'
        });

        const result = await response.json();

        if (result.success) {
          successDiv.textContent = 'Password changed successfully! Refreshing...';
          successDiv.classList.remove('d-none');
          
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          errorDiv.textContent = result.message || 'Failed to change password';
          errorDiv.classList.remove('d-none');
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
        }
      } catch (error) {
        console.error('Password change error:', error);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      checkDefaultPassword();
    });

    // Staff logout functionality
    document.getElementById('staffLogoutBtn')?.addEventListener('click', async function() {
      try {
        const staffId = sessionStorage.getItem('staff_id');
        
        if (!staffId) {
          window.location.href = 'staff-login.html';
          return;
        }
        
        const formData = new FormData();
        formData.append('staff_id', staffId);
        
        const response = await fetch('log_logout.php', {
          method: 'POST',
          body: formData,
          cache: 'no-store'
        });
        
        const result = await response.json();
        
        if (result.success) {
          sessionStorage.clear();
          window.location.href = 'staff-login.html';
        } else {
          console.error('Logout logging failed:', result.error);
          sessionStorage.clear();
          window.location.href = 'staff-login.html';
        }
      } catch (error) {
        console.error('Logout error:', error);
        sessionStorage.clear();
        window.location.href = 'staff-login.html';
      }
    });
  </script>
  
</body>
</html>
