<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>eBarangay | Staff Dashboard - Settings</title>
  <link rel="icon" type="image/jpeg" href="pics/eb-logo.jpg" /> <!-- FAVICON -->
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Notification styles moved to style.css (centralized). */
    /* Responsive modal buttons: stack and full-width on small screens */
    .modal .modal-footer .btn {
      min-width: 100px;
    }
  </style>
</head>
<body>
  
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="padding: 0.5rem 0; margin-top: -8px; padding-top: calc(0.5rem + 8px); z-index: 1050;">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="staff-dashboard.html">
        <img src="pics/eb-logo.jpg" alt="eBarangay Logo" class="me-2" style="height:40px; width:auto" />
        <span class=>STAFF DASHBOARD</span>
      </a>
      <div class="d-flex align-items-center position-relative">
        <!-- Sidebar toggle for small screens -->
        <button id="sidebarToggleBtn" class="btn btn-light d-md-none me-2" aria-label="Open sidebar">
          <i class="bi bi-list"></i>
        </button>
        <div class="dropdown me-2">
          <button class="btn btn-light position-relative" id="notifButton" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            <i class="bi bi-bell fs-5"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notifBadge">0</span>
          </button>

          <div class="dropdown-menu dropdown-menu-end shadow-sm p-0 border-0" id="notifDropdown" style="width:340px;">
            <div class="p-3 border-bottom bg-light">
              <h6 class="fw-bold mb-0">Notifications</h6>
            </div>

            <!-- Main notifications -->
            <div class="notification-panel">
              <!-- Notifications will be loaded dynamically via JavaScript -->
            </div>
          </div>
        </div>
        <button class="btn btn-outline-light btn-sm" id="staffLogoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <!-- First Login Password Change Modal -->
  <div class="modal fade" id="firstLoginPasswordModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="firstLoginPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="firstLoginPasswordModalLabel">
            <i class="bi bi-shield-exclamation me-2"></i>Password Change Required
          </h5>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Security Notice:</strong> You are using the default password. For your account's security, you must change your password before continuing.
          </div>
          
          <form id="firstLoginPasswordForm">
            <div class="mb-3">
              <label for="firstLoginOldPassword" class="form-label fw-semibold">Old Password</label>
              <input type="password" class="form-control" id="firstLoginOldPassword" placeholder="Enter current password" required>
            </div>
            <div class="mb-3">
              <label for="firstLoginNewPassword" class="form-label fw-semibold">New Password</label>
              <input type="password" class="form-control" id="firstLoginNewPassword" placeholder="Enter new password" required>
            </div>
            
            <div class="mb-3">
              <label for="firstLoginConfirmPassword" class="form-label fw-semibold">Confirm New Password</label>
              <input type="password" class="form-control" id="firstLoginConfirmPassword" placeholder="Confirm new password" required>
            </div>

            <div class="small text-muted mb-3">
              <strong>Password requirements:</strong>
              <ul class="mb-0 mt-1">
                <li id="firstLogin-rule-length" class="text-muted">At least 8 characters</li>
                <li id="firstLogin-rule-uppercase" class="text-muted">Contains an uppercase letter (A-Z)</li>
                <li id="firstLogin-rule-lowercase" class="text-muted">Contains a lowercase letter (a-z)</li>
                <li id="firstLogin-rule-number" class="text-muted">Contains a number (0-9)</li>
                <li id="firstLogin-rule-special" class="text-muted">Contains a special character (!@#$%^&*)</li>
              </ul>
            </div>

            <div id="firstLoginPasswordError" class="alert alert-danger small d-none"></div>
            <div id="firstLoginPasswordSuccess" class="alert alert-success small d-none"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="firstLoginSubmitBtn">
            <i class="bi bi-check-circle me-1"></i>Change Password
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
  <!-- Sidebar -->
  <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3 shadow-sm" id="mainSidebar" style="position: fixed; top: 65px; left: 0; height: calc(100vh - 65px); overflow-y: auto; z-index: 1000;">
        <div class="nav flex-column">
          <a class="nav-link" href="staff-dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
          <a class="nav-link" href="sidebar-requests.php"><i class="bi bi-files me-2"></i> Requests</a>
          <a class="nav-link" href="sidebar-residents.php"><i class="bi bi-people me-2"></i> Residents</a>
          <a class="nav-link" href="sidebar-reports.html"><i class="bi bi-clipboard-data me-2"></i> Reports</a>
          <a class="nav-link active" href="sidebar-profile.html"><i class="bi bi-card-list me-2"></i> Profile</a>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
          <!-- Account -->
          <div class="tab-pane fade show active" id="account">
            <div class="card shadow-sm mb-3">
              <div class="card-body">
                <!-- Profile preview (placeholder) -->
                <div class="d-flex align-items-center mb-3">
                  <img id="staffAvatarImg" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='%23f1f3f5'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-size='20' fill='%23999'>STAFF</text></svg>" alt="Staff avatar" class="rounded-circle me-3 shadow-sm" style="width:96px;height:96px;object-fit:cover;">
                  <div>
                    <div class="fw-semibold" id="staffDisplayName">Loading...</div>
                    <div class="small text-muted">Barangay Staff</div>
                    <div class="mt-2">
                      <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/gif,image/webp" class="d-none">
                      <button type="button" class="btn btn-sm btn-outline-secondary" id="avatarBtn"><i class="bi bi-upload"></i> Upload Photo</button>
                      <button type="button" class="btn btn-sm btn-outline-success d-none" id="saveAvatarBtn"><i class="bi bi-check-lg"></i> Save Photo</button>
                      <button type="button" class="btn btn-sm btn-link text-danger d-none" id="removeAvatarBtn">Remove</button>
                      <div class="small text-muted mt-1" id="avatarLockNote"></div>
                      <div id="avatarAlert" class="small mt-1"></div>
                    </div>
                  </div>
                </div>
                <h5 class="fw-bold mb-3">My Account</h5>
                <form>
                  <div class="row mb-3">
                    <div class="col-md-3">
                      <label class="form-label">Last Name<span style="color: red;">*</span></label>
                      <input type="text" id="accountLastName" class="form-control" required disabled>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">First Name<span style="color: red;">*</span></label>
                      <input type="text" id="accountFirstName" class="form-control" required disabled>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Middle Name</label>
                      <input type="text" id="accountMiddleName" class="form-control" disabled>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Suffix</label>
                      <input type="text" id="accountSuffix" class="form-control" disabled>
                    </div>
                  </div>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Gender</label>
                      <select id="accountGender" class="form-select" disabled>
                        <option value="">Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Civil Status</label>
                      <select id="accountCivilStatus" class="form-select" disabled>
                        <option value="">Select civil status</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Widowed">Widowed</option>
                        <option value="Divorced">Divorced</option>
                      </select>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email / Username<span style="color: red;">*</span></label>
                    <input type="email" id="accountEmail" class="form-control" required disabled>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Contact Number<span style="color: red;">*</span></label>
                    <input type="text" id="accountContact" class="form-control" required disabled>
                    <div id="accountContactError" class="small text-danger d-none mt-1">Enter a valid 11- digit number starting with 0 to 9.</div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Change Password</label>
                    <input type="password" class="form-control mb-2" id="passwordNewInline" placeholder="New password" disabled>
                    <input type="password" class="form-control mb-2" id="passwordConfirmInline" placeholder="Confirm new password" disabled>
                    <div id="passwordError" class="small text-danger d-none mt-1"></div>
                    <div id="saveAccountMsg" class="small mt-2 d-none"></div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary" id="editAccountBtn">Edit</button>
                    <button type="button" class="btn btn-success" id="saveAccountBtn">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          
         
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Notification fetching and handling
      const notifButton = document.getElementById("notifButton");
      const notifBadge = document.getElementById("notifBadge");

      // Get icon and color based on notification type
      function getNotificationIcon(type) {
        const icons = {
          'document_request': { icon: 'bi-file-earmark-text', color: 'text-primary' },
          'payment_sent': { icon: 'bi-credit-card', color: 'text-success' },
          'new_registration': { icon: 'bi-person-plus', color: 'text-info' },
          'profile_update': { icon: 'bi-pencil-square', color: 'text-warning' },
          'default': { icon: 'bi-bell-fill', color: 'text-primary' }
        };
        return icons[type] || icons['default'];
      }

      // Format time ago
      function timeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
        return date.toLocaleDateString();
      }

      async function fetchNotifications() {
        try {
          const res = await fetch('get_notifications.php', { cache: 'no-store' });
          const data = await res.json();
          const panel = document.querySelector('.notification-panel');
          if (!panel) return;
          
          panel.innerHTML = '';

          // Normalize response shape - handle both formats
          let notifs = [];
          let unreadCount = 0;
          
          if (data && data.success) {
            notifs = data.data || [];
            unreadCount = data.unread_count || 0;
          } else if (Array.isArray(data)) {
            notifs = data;
            unreadCount = data.filter(n => !n.is_read).length;
          }

          if (notifBadge) {
            notifBadge.textContent = unreadCount;
            notifBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
          }

          if (notifs.length === 0) {
            panel.innerHTML = '<div class="p-3 text-center text-muted"><i class="bi bi-bell-slash me-2"></i>No notifications yet</div>';
            return;
          }

          notifs.forEach(n => {
            const item = document.createElement('div');
            const isRead = Number(n.is_read ?? n.read ?? 0) === 1;
            const iconInfo = getNotificationIcon(n.type || n.notification_type);
            const timeStr = n.created_at ? timeAgo(n.created_at) : '';
            
            item.className = 'notif-item p-3 border-bottom' + (isRead ? '' : ' unread');
            item.style.cursor = 'pointer';
            item.innerHTML = `
              <div class="d-flex align-items-start">
                <i class="bi ${iconInfo.icon} me-2 ${iconInfo.color} fs-5"></i>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <h6 class="mb-1 fw-semibold text-dark" style="font-size: 0.9rem;">${escapeHtml(n.title || 'Notification')}</h6>
                    <small class="text-muted ms-2" style="white-space: nowrap;">${timeStr}</small>
                  </div>
                  <p class="mb-0 small text-secondary">${escapeHtml(n.message || '')}</p>
                </div>
              </div>
            `;

            item.addEventListener('click', async () => {
              if (!isRead) {
                try {
                  await fetch('mark_notification_read.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: n.id })
                  });
                } catch (err) {
                  console.error('mark read failed', err);
                }
              }
              // Navigate based on notification type
              if (n.type === 'document_request' || n.type === 'payment_sent') {
                window.location.href = 'sidebar-requests.php';
              } else if (n.type === 'new_registration' || n.type === 'profile_update') {
                window.location.href = 'sidebar-residents.php';
              } else {
                window.location.href = 'sidebar-requests.php';
              }
            });

            panel.appendChild(item);
          });
        } catch (err) {
          console.error('Failed to fetch notifications', err);
          const panel = document.querySelector('.notification-panel');
          if (panel) {
            panel.innerHTML = '<div class="p-3 text-center text-muted"><i class="bi bi-exclamation-circle me-2"></i>Failed to load notifications</div>';
          }
        }
      }

      function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // Initial load and polling
      fetchNotifications();
      setInterval(fetchNotifications, 60000); // Poll every 1 minute

      const notifPanel = document.querySelector('.notification-panel');
      if (notifPanel) {
        let initialCount = notifPanel.querySelectorAll('.notif-item').length;
        const mo = new MutationObserver(muts => {
          muts.forEach(m => {
            if (m.addedNodes && m.addedNodes.length) {
              const newItems = Array.from(m.addedNodes).filter(n => n.classList && n.classList.contains('notif-item'));
              if (newItems.length) {
                try { playNotificationSound(); } catch(e){}
              }
              initialCount = notifPanel.querySelectorAll('.notif-item').length;
            }
          });
        });
        mo.observe(notifPanel, { childList: true, subtree: false });
      }

      const dropdownEl = document.getElementById('notifButton');
      if (dropdownEl) {
        dropdownEl.addEventListener('shown.bs.dropdown', function () {
          const unread = document.querySelectorAll('.notification-panel .notif-item.unread').length;
          if (unread > 0) { try { playNotificationSound(); } catch(e){} }
        });
      }

      // Responsive sidebar toggle (small screens)
      const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
      const mainSidebar = document.getElementById('mainSidebar');
      if (sidebarToggleBtn && mainSidebar) {
        sidebarToggleBtn.addEventListener('click', (e) => {
          e.preventDefault();
          mainSidebar.classList.toggle('show-mobile');
        });

        // close sidebar when clicking outside on small screens
        document.addEventListener('click', (ev) => {
          if (!mainSidebar.classList.contains('show-mobile')) return;
          const target = ev.target;
          if (!mainSidebar.contains(target) && target !== sidebarToggleBtn && !sidebarToggleBtn.contains(target)) {
            mainSidebar.classList.remove('show-mobile');
          }
        });
      }
    });
  </script>
  <style>
    /* Small-screen sidebar slide-in (keeps desktop design) */
    @media (max-width: 767.98px) {
      #mainSidebar {
        position: fixed !important;
        left: -100%;
        top: 64px; /* account for navbar height */
        width: 78%;
        height: calc(100% - 64px);
        background: #fff;
        z-index: 2050;
        transition: left 220ms ease;
        box-shadow: 0 6px 24px rgba(0,0,0,0.12);
      }
      #mainSidebar.show-mobile {
        left: 0;
      }
      /* dim the main content when sidebar open */
      #mainSidebar.show-mobile ~ main,
      #mainSidebar.show-mobile ~ .container-fluid {
        filter: brightness(0.95);
      }
    }
  </style>
  
 

  <script>
    // Persist page DOM notifications into central localStorage so other pages (Reports/Settings) can read them
    document.addEventListener('DOMContentLoaded', function () {
      try {
        const STORAGE_KEY = 'eb_notifications_v1';
        const raw = localStorage.getItem(STORAGE_KEY);
        const stored = raw ? JSON.parse(raw) : [];
        const els = Array.from(document.querySelectorAll('.notif-item'));
        const base = Date.now();
        els.forEach((el, idx) => {
          const obj = {
            id: el.getAttribute('data-id') || `n-${base}-${idx}`,
            title: el.getAttribute('data-title') || el.querySelector('h6')?.textContent || 'Notification',
            message: el.getAttribute('data-message') || el.querySelector('p')?.textContent || '',
            url: el.getAttribute('data-url') || '#',
            unread: el.classList.contains('unread'),
            iconClass: el.querySelector('i') ? Array.from(el.querySelector('i').classList).join(' ') : 'bi bi-bell-fill'
          };
          const exists = stored.some(u => (u.id && obj.id && u.id === obj.id) || (u.title === obj.title && u.message === obj.message && u.url === obj.url));
          if (!exists) stored.push(obj);
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stored));
      } catch (e) { /* ignore */ }
    });
  </script>

  <script src="script.js"></script>

  <!-- Change Password Modal (Settings) -->
  <div class="modal fade" id="changePasswordModalSettings" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="changeMsgSettings" class="alert d-none" role="alert"></div>
          <form id="changePasswordFormSettings">
            <div class="mb-3" id="currentPwRowSettings">
              <label class="form-label">Current Password</label>
              <input type="password" id="currentPasswordSet" class="form-control" autocomplete="current-password">
              <div id="currentPasswordErrorSet" class="small text-danger d-none mt-1">Current password is incorrect.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" id="newPasswordSet" class="form-control" autocomplete="new-password">
            </div>

            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input type="password" id="confirmPasswordSet" class="form-control" autocomplete="new-password">
              <div id="confirmPasswordErrorSet" class="small text-danger d-none mt-1">Passwords do not match.</div>
            </div>

            <div class="mb-2">
              <div class="small text-muted mb-1">Password rules:</div>
              <ul class="small mb-0" id="pwRulesListSettings">
                <li id="rule-length-set">At least 8 characters</li>
                <li id="rule-upper-set">At least one uppercase letter</li>
                <li id="rule-lower-set">At least one lowercase letter</li>
                <li id="rule-digit-set">At least one digit</li>
                <li id="rule-special-set">At least one special character (!@#$%^&*)</li>
                <li id="rule-nospaces-set">No spaces</li>
              </ul>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveNewPasswordSet" class="btn btn-primary">Save Password</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      function formatTs(ts) { try { return new Date(ts).toLocaleString(); } catch (e) { return 'Unknown'; } }

      const openBtn = document.getElementById('openChangeFromSettings');
      const emailInput = document.querySelector('#account input[type="email"]') || document.querySelector('input[type="email"]');
      const pwChangedAtEl = document.getElementById('pwChangedAt');

      function refreshPwChanged() {
        try {
          const email = (emailInput && emailInput.value) ? emailInput.value.trim() : 'unknown';
          const ts = localStorage.getItem('passwordChangedAt_' + email);
          pwChangedAtEl.textContent = ts ? formatTs(parseInt(ts,10) || ts) : 'Never';
        } catch (e) { pwChangedAtEl.textContent = 'Never'; }
      }

      document.addEventListener('DOMContentLoaded', refreshPwChanged);

      if (openBtn) {
        openBtn.addEventListener('click', function(){
          const email = (emailInput && emailInput.value) ? emailInput.value.trim() : '';
          const modalEl = document.getElementById('changePasswordModalSettings');
          const modal = new bootstrap.Modal(modalEl);

          document.getElementById('changeMsgSettings').className = 'alert d-none';
          document.getElementById('currentPasswordErrorSet').classList.add('d-none');
          document.getElementById('confirmPasswordErrorSet').classList.add('d-none');
          document.getElementById('currentPasswordSet').value = '';
          document.getElementById('newPasswordSet').value = '';
          document.getElementById('confirmPasswordSet').value = '';

          const stored = localStorage.getItem('password_' + email);
          const currentRow = document.getElementById('currentPwRowSettings');
          if (stored) { currentRow.style.display = ''; } else { currentRow.style.display = 'none'; }

          function updateRules(val) {
            const rules = {
              length: val.length >= 8,
              upper: /[A-Z]/.test(val),
              lower: /[a-z]/.test(val),
              digit: /[0-9]/.test(val),
              special: /[!@#\$%\^&\*]/.test(val),
              nospaces: !/\s/.test(val)
            };
            document.getElementById('rule-length-set').style.color = rules.length ? 'green' : '';
            document.getElementById('rule-upper-set').style.color = rules.upper ? 'green' : '';
            document.getElementById('rule-lower-set').style.color = rules.lower ? 'green' : '';
            document.getElementById('rule-digit-set').style.color = rules.digit ? 'green' : '';
            document.getElementById('rule-special-set').style.color = rules.special ? 'green' : '';
            document.getElementById('rule-nospaces-set').style.color = rules.nospaces ? 'green' : '';
            return Object.values(rules).every(Boolean);
          }

          const newPwEl = document.getElementById('newPasswordSet');
          const confirmPwEl = document.getElementById('confirmPasswordSet');
          newPwEl.addEventListener('input', function(){ updateRules(this.value); document.getElementById('confirmPasswordErrorSet').classList.add('d-none'); });

          document.getElementById('saveNewPasswordSet').onclick = function(){
            const newPw = newPwEl.value || '';
            const confirmPw = confirmPwEl.value || '';
            const currentPw = document.getElementById('currentPasswordSet').value || '';

            if (newPw !== confirmPw) { document.getElementById('confirmPasswordErrorSet').classList.remove('d-none'); return; }
            const ok = updateRules(newPw);
            if (!ok) { const msg = document.getElementById('changeMsgSettings'); msg.className = 'alert alert-warning'; msg.textContent = 'Password does not meet the required rules.'; msg.classList.remove('d-none'); return; }

            const emailKey = email || '';
            const storedPw = localStorage.getItem('password_' + emailKey);
            if (storedPw) { if (currentPw !== storedPw) { document.getElementById('currentPasswordErrorSet').classList.remove('d-none'); return; } }

            try { localStorage.setItem('password_' + emailKey, newPw); localStorage.setItem('passwordChangedAt_' + emailKey, String(Date.now())); } catch (e) {}

            const msg = document.getElementById('changeMsgSettings'); msg.className = 'alert alert-success'; msg.textContent = 'Password successfully changed.'; msg.classList.remove('d-none');
            setTimeout(function(){ try { bootstrap.Modal.getInstance(modalEl).hide(); } catch (e) {} ; refreshPwChanged(); }, 900);
          };

          modal.show();
        });
      }
    })();
  </script>

  <script>
    // Avatar upload & persist to database
    // Once an avatar is uploaded it is locked (no further changes) to prevent unnecessary updates.
    let selectedAvatarFile = null;
    let hasExistingAvatar = false;
    
    document.addEventListener('DOMContentLoaded', function () {
      const placeholder = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='%23f1f3f5'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-size='20' fill='%23999'>STAFF</text></svg>";
      const img = document.getElementById('staffAvatarImg');
      const input = document.getElementById('avatarInput');
      const btn = document.getElementById('avatarBtn');
      const saveBtn = document.getElementById('saveAvatarBtn');
      const removeBtn = document.getElementById('removeAvatarBtn');
      const note = document.getElementById('avatarLockNote');
      const alertEl = document.getElementById('avatarAlert');
      if (!img || !input || !btn) return;

      function showAvatarAlert(msg, success) {
        if (!alertEl) return;
        alertEl.innerHTML = '<span class="' + (success ? 'text-success' : 'text-danger') + '">' + msg + '</span>';
        setTimeout(() => { if (alertEl) alertEl.innerHTML = ''; }, 4000);
      }

      function showAvatar(url) {
        if (url) {
          img.src = url + '?t=' + Date.now();
          hasExistingAvatar = true;
        } else {
          img.src = placeholder;
          hasExistingAvatar = false;
        }
      }

      function updateButtonState() {
        if (hasExistingAvatar) {
          btn.innerHTML = '<i class="bi bi-check-circle"></i> Uploaded';
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-success');
          btn.disabled = true;
          if (note) note.textContent = 'Profile photo uploaded â€” changes are locked. Contact administrator to change.';
          if (removeBtn) removeBtn.classList.add('d-none');
          if (saveBtn) saveBtn.classList.add('d-none');
          input.disabled = true;
        } else {
          btn.innerHTML = '<i class="bi bi-upload"></i> Upload Photo';
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-secondary');
          btn.disabled = false;
          if (note) note.textContent = '';
          input.disabled = false;
        }
      }

      // Load avatar from database (called when profile loads)
      window.loadStaffAvatar = function(profilePic) {
        if (profilePic) {
          showAvatar(profilePic);
          updateButtonState();
        } else {
          showAvatar(null);
          updateButtonState();
        }
      };

      // Upload button click - open file picker
      btn.addEventListener('click', function () {
        if (!hasExistingAvatar) {
          input.click();
        }
      });

      // File selected
      input.addEventListener('change', function (e) {
        const file = (e.target.files && e.target.files[0]) || null;
        if (!file) return;
        
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
          showAvatarAlert('Invalid file type. Allowed: JPG, PNG, GIF, WEBP', false);
          input.value = '';
          return;
        }
        
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showAvatarAlert('File size exceeds 5MB limit.', false);
          input.value = '';
          return;
        }
        
        selectedAvatarFile = file;
        
        // Preview the image
        const reader = new FileReader();
        reader.onload = function (ev) {
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
        
        // Show save button
        if (saveBtn) {
          saveBtn.classList.remove('d-none');
        }
      });

      // Save button click - upload to server
      if (saveBtn) {
        saveBtn.addEventListener('click', async function () {
          if (!selectedAvatarFile) return;
          
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
          
          const formData = new FormData();
          formData.append('profile_pic', selectedAvatarFile);
          
          try {
            const response = await fetch('upload_staff_profile_pic.php', {
              method: 'POST',
              body: formData
            });
            const result = await response.json();
            
            if (result.success) {
              showAvatarAlert('Profile photo saved!', true);
              hasExistingAvatar = true;
              updateButtonState();
              selectedAvatarFile = null;
              input.value = '';
            } else {
              showAvatarAlert(result.message || 'Upload failed', false);
            }
          } catch (error) {
            showAvatarAlert('Network error uploading photo', false);
          }
          
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save Photo';
          saveBtn.classList.add('d-none');
        });
      }
    });
  </script>

  <script>
    (function () {
      // Keep the notifBadge in sync with stored notifications or DOM unread items
      function refreshBadge() {
        try {
          const badge = document.getElementById('notifBadge');
          if (!badge) return;
          let unread = 0;

          // Prefer central stored notifications when available
          if (typeof window.getStoredNotifications === 'function') {
            try {
              const stored = window.getStoredNotifications() || [];
              unread = Array.isArray(stored) ? stored.filter(s => s.unread).length : 0;
            } catch (e) {
              unread = document.querySelectorAll('.notification-panel .notif-item.unread').length;
            }
          } else {
            // Fallback: count unread items in DOM
            unread = document.querySelectorAll('.notification-panel .notif-item.unread').length;
          }

          badge.textContent = unread;
          badge.style.display = unread > 0 ? 'inline-block' : 'none';
        } catch (e) { /* ignore */ }
      }

      document.addEventListener('DOMContentLoaded', function () {
        refreshBadge();
        // Watch for changes inside the notification panel (new items or class changes)
        const panel = document.querySelector('.notification-panel');
        if (panel && window.MutationObserver) {
          const mo = new MutationObserver(() => refreshBadge());
          mo.observe(panel, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
        }
      });

      // Update when other tabs change stored notifications
      window.addEventListener('storage', function (e) {
        if (!e || e.key !== 'eb_notifications_v1') return;
        refreshBadge();
      });
    })();
  </script>

  <script>
    // Store staff data globally for field locking logic
    let staffProfileData = null;

    // Load staff profile from database
    async function loadStaffProfile() {
      try {
        const response = await fetch('get_staff_profile.php');
        const result = await response.json();
        
        if (result.success && result.data) {
          const staff = result.data;
          staffProfileData = staff; // Store for later use
          
          // Update display name
          const displayName = document.getElementById('staffDisplayName');
          if (displayName) {
            displayName.textContent = staff.first_name + ' ' + staff.last_name;
          }
          
          // Populate form fields
          document.getElementById('accountFirstName').value = staff.first_name || '';
          document.getElementById('accountMiddleName').value = staff.middle_name || '';
          document.getElementById('accountLastName').value = staff.last_name || '';
          document.getElementById('accountSuffix').value = staff.suffix || '';
          document.getElementById('accountEmail').value = staff.email || '';
          document.getElementById('accountContact').value = staff.contact_number || '';
          
          // Populate gender and civil status
          const genderSelect = document.getElementById('accountGender');
          const civilStatusSelect = document.getElementById('accountCivilStatus');
          
          if (genderSelect && staff.gender) {
            genderSelect.value = staff.gender;
          }
          if (civilStatusSelect && staff.civil_status) {
            civilStatusSelect.value = staff.civil_status;
          }
          
          // Load profile picture from database
          if (typeof window.loadStaffAvatar === 'function') {
            window.loadStaffAvatar(staff.profile_pic);
          }
          
          // Apply field locking based on gender and civil status
          applyStaffFieldLocking(staff);
        } else {
          console.error('Failed to load profile:', result.message);
          alert('Failed to load profile. Please login again.');
          window.location.href = 'staff-login.html';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('Error loading profile. Please login again.');
        window.location.href = 'staff-login.html';
      }
    }

    // Apply field locking rules based on gender and civil status
    function applyStaffFieldLocking(staff) {
      const gender = staff.gender || '';
      const civilStatus = staff.civil_status || '';
      const nameEditUsed = staff.name_edit_used == 1 || staff.name_edit_used === true;
      
      const firstNameField = document.getElementById('accountFirstName');
      const middleNameField = document.getElementById('accountMiddleName');
      const lastNameField = document.getElementById('accountLastName');
      const suffixField = document.getElementById('accountSuffix');
      const genderField = document.getElementById('accountGender');
      const civilStatusField = document.getElementById('accountCivilStatus');
      
      // Reset lock attributes
      [firstNameField, middleNameField, lastNameField, suffixField, genderField, civilStatusField].forEach(field => {
        if (field) {
          field.removeAttribute('data-locked');
        }
      });
      
      // Gender is ALWAYS permanently locked for all staff
      if (genderField) genderField.setAttribute('data-locked', 'true');
      
      if (gender === 'Male') {
        // Male: Full name (first, middle, last, suffix) + civil status permanently locked
        [firstNameField, middleNameField, lastNameField, suffixField, civilStatusField].forEach(field => {
          if (field) field.setAttribute('data-locked', 'true');
        });
      } else if (gender === 'Female') {
        // Female: First name and suffix always locked
        [firstNameField, suffixField].forEach(field => {
          if (field) field.setAttribute('data-locked', 'true');
        });
        
        if (civilStatus === 'Married' || civilStatus === 'Widowed' || civilStatus === 'Divorced') {
          // If married/widowed/divorced: middle name, last name, civil status are locked
          [middleNameField, lastNameField, civilStatusField].forEach(field => {
            if (field) field.setAttribute('data-locked', 'true');
          });
        } else if (civilStatus === 'Single') {
          if (nameEditUsed) {
            // Already used the one-time edit: lock middle name, last name, civil status
            [middleNameField, lastNameField, civilStatusField].forEach(field => {
              if (field) field.setAttribute('data-locked', 'true');
            });
          }
          // Single and hasn't used edit: can edit middle name, last name, civil status once
        }
        // No civil status set yet for female: only first name, suffix, gender locked
      } else {
        // Gender not set or "Other"/"Prefer not to say" - treat like male (all locked)
        [firstNameField, middleNameField, lastNameField, suffixField, civilStatusField].forEach(field => {
          if (field) field.setAttribute('data-locked', 'true');
        });
      }
    }

    // Check if a field is locked
    function isFieldLocked(fieldId) {
      const field = document.getElementById(fieldId);
      return field && field.getAttribute('data-locked') === 'true';
    }
    
    // Call on page load
    document.addEventListener('DOMContentLoaded', loadStaffProfile);
  </script>

  <script>
    // Inline edit handler: enable editing of Contact and Password inside the Account card (no modal)
    document.addEventListener('DOMContentLoaded', function () {
      const editBtn = document.getElementById('editAccountBtn');
      const saveBtn = document.getElementById('saveAccountBtn');
      const emailInput = document.getElementById('accountEmail');
      const contactInput = document.getElementById('accountContact');
      const contactErr = document.getElementById('accountContactError');
      const newPwEl = document.getElementById('passwordNewInline');
      const confirmPwEl = document.getElementById('passwordConfirmInline');
      const msgEl = document.getElementById('saveAccountMsg');
      const pwErr = document.getElementById('passwordError');
      
      // Name fields for editing
      const firstNameInput = document.getElementById('accountFirstName');
      const middleNameInput = document.getElementById('accountMiddleName');
      const lastNameInput = document.getElementById('accountLastName');
      const suffixInput = document.getElementById('accountSuffix');
      const genderSelect = document.getElementById('accountGender');
      const civilStatusSelect = document.getElementById('accountCivilStatus');

      if (!editBtn || !saveBtn || !emailInput || !contactInput || !newPwEl || !confirmPwEl || !msgEl) return;

      function sanitizeDigits(val) { return String(val || '').replace(/\D+/g, ''); }
      function formatPHMobile(v){
        const d = sanitizeDigits(v);
        if (!d) return '';
        if (d.length <=4) return d;
        if (d.length <=7) return d.replace(/(\d{4})(\d+)/,'$1-$2');
        return d.replace(/(\d{4})(\d{3})(\d{0,4}).*/,'$1-$2-$3');
      }
      function isValidPHMobile(v){ return /^09\d{9}$/.test(sanitizeDigits(v)); }

      // Store original values so Cancel can revert
      contactInput.setAttribute('data-original', contactInput.value || '');
      
      function storeOriginalValues() {
        firstNameInput.setAttribute('data-original', firstNameInput.value || '');
        middleNameInput.setAttribute('data-original', middleNameInput.value || '');
        lastNameInput.setAttribute('data-original', lastNameInput.value || '');
        suffixInput.setAttribute('data-original', suffixInput.value || '');
        genderSelect.setAttribute('data-original', genderSelect.value || '');
        civilStatusSelect.setAttribute('data-original', civilStatusSelect.value || '');
      }
      
      function restoreOriginalValues() {
        firstNameInput.value = firstNameInput.getAttribute('data-original') || '';
        middleNameInput.value = middleNameInput.getAttribute('data-original') || '';
        lastNameInput.value = lastNameInput.getAttribute('data-original') || '';
        suffixInput.value = suffixInput.getAttribute('data-original') || '';
        genderSelect.value = genderSelect.getAttribute('data-original') || '';
        civilStatusSelect.value = civilStatusSelect.getAttribute('data-original') || '';
      }

      // Live formatting while typing (only when enabled)
      contactInput.addEventListener('input', function () {
        const p = this.selectionStart;
        const formatted = formatPHMobile(this.value);
        this.value = formatted;
      });

      // Password strength validation function
      function validatePasswordStrength(password) {
        const rules = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        return Object.values(rules).every(Boolean);
      }

      let editing = false;
      editBtn.addEventListener('click', function () {
        editing = !editing;
        if (editing) {
          // Store original values before editing
          storeOriginalValues();
          
          // Enter edit mode - enable contact and password fields
          contactInput.disabled = false;
          newPwEl.disabled = false;
          confirmPwEl.disabled = false;
          
          // Enable name fields only if NOT locked
          if (!isFieldLocked('accountFirstName')) firstNameInput.disabled = false;
          if (!isFieldLocked('accountMiddleName')) middleNameInput.disabled = false;
          if (!isFieldLocked('accountLastName')) lastNameInput.disabled = false;
          if (!isFieldLocked('accountSuffix')) suffixInput.disabled = false;
          if (!isFieldLocked('accountGender')) genderSelect.disabled = false;
          if (!isFieldLocked('accountCivilStatus')) civilStatusSelect.disabled = false;
          
          contactInput.focus();
          editBtn.textContent = 'Cancel';
        } else {
          // Cancel edits: revert all values
          contactInput.value = contactInput.getAttribute('data-original') || '';
          restoreOriginalValues();
          
          // Disable all fields
          contactInput.disabled = true;
          firstNameInput.disabled = true;
          middleNameInput.disabled = true;
          lastNameInput.disabled = true;
          suffixInput.disabled = true;
          genderSelect.disabled = true;
          civilStatusSelect.disabled = true;
          newPwEl.value = '';
          confirmPwEl.value = '';
          newPwEl.disabled = true;
          confirmPwEl.disabled = true;
          contactErr.classList.add('d-none');
          msgEl.classList.add('d-none');
          if (pwErr) pwErr.classList.add('d-none');
          editBtn.textContent = 'Edit';
          
          // Reset password indicators
          ['rule-length', 'rule-uppercase', 'rule-lowercase', 'rule-number', 'rule-special'].forEach(id => {
            document.getElementById(id).style.color = '';
          });
        }
      });

      function showMsg(type, text) {
        msgEl.className = 'alert alert-' + type + ' small mt-2';
        msgEl.textContent = text;
        msgEl.classList.remove('d-none');
      }

      saveBtn.addEventListener('click', async function (e) {
        e.preventDefault();
        contactErr.classList.add('d-none');
        msgEl.classList.add('d-none');
        if (pwErr) pwErr.classList.add('d-none');

        const email = (emailInput && emailInput.value) ? emailInput.value.trim() : '';
        if (!email) { showMsg('warning', 'Email is required.'); return; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) { showMsg('warning', 'Please enter a valid email address.'); return; }

        let profileUpdated = false;
        let contactUpdated = false;
        let passwordUpdated = false;

        // Check if any name/civil status fields were changed and need to be saved
        const nameFieldsChanged = (
          (!isFieldLocked('accountFirstName') && firstNameInput.value !== firstNameInput.getAttribute('data-original')) ||
          (!isFieldLocked('accountMiddleName') && middleNameInput.value !== middleNameInput.getAttribute('data-original')) ||
          (!isFieldLocked('accountLastName') && lastNameInput.value !== lastNameInput.getAttribute('data-original')) ||
          (!isFieldLocked('accountSuffix') && suffixInput.value !== suffixInput.getAttribute('data-original')) ||
          (!isFieldLocked('accountCivilStatus') && civilStatusSelect.value !== civilStatusSelect.getAttribute('data-original'))
        );

        if (nameFieldsChanged && editing) {
          // Update profile fields via API
          try {
            const formData = new FormData();
            formData.append('first_name', firstNameInput.value.trim());
            formData.append('middle_name', middleNameInput.value.trim());
            formData.append('last_name', lastNameInput.value.trim());
            formData.append('suffix', suffixInput.value.trim());
            formData.append('civil_status', civilStatusSelect.value);

            const response = await fetch('update_staff_profile.php', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (result.success) {
              profileUpdated = true;
              // Update the stored original values
              firstNameInput.setAttribute('data-original', firstNameInput.value);
              middleNameInput.setAttribute('data-original', middleNameInput.value);
              lastNameInput.setAttribute('data-original', lastNameInput.value);
              suffixInput.setAttribute('data-original', suffixInput.value);
              civilStatusSelect.setAttribute('data-original', civilStatusSelect.value);
              
              // Update display name
              const displayName = document.getElementById('staffDisplayName');
              if (displayName) {
                displayName.textContent = firstNameInput.value + ' ' + lastNameInput.value;
              }
              
              // Reload profile to update locking status (if name_edit_used was set)
              await loadStaffProfile();
            } else {
              showMsg('danger', result.message || 'Failed to update profile.');
              return;
            }
          } catch (error) {
            console.error('Profile update error:', error);
            showMsg('danger', 'Error updating profile. Please try again.');
            return;
          }
        }

        // If in editing mode, validate and save contact number
        const contactVal = contactInput.value ? contactInput.value.trim() : '';
        if (!contactInput.disabled) {
          if (!isValidPHMobile(contactVal)) {
            contactErr.classList.remove('d-none');
            contactInput.focus();
            return;
          }
          
          // Update contact number in database
          try {
            const formData = new FormData();
            formData.append('contact_number', sanitizeDigits(contactVal));

            const response = await fetch('update_staff_contact.php', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (result.success) {
              const formatted = formatPHMobile(contactVal);
              contactInput.value = formatted;
              contactInput.setAttribute('data-original', formatted);
              contactInput.disabled = true;
              contactUpdated = true;
            } else {
              contactErr.textContent = result.message || 'Failed to update contact number.';
              contactErr.classList.remove('d-none');
              return;
            }
          } catch (error) {
            console.error('Contact update error:', error);
            contactErr.textContent = 'Error updating contact number. Please try again.';
            contactErr.classList.remove('d-none');
            return;
          }
        }

        const newPw = (newPwEl.value || '').trim();
        const confirmPw = (confirmPwEl.value || '').trim();

        // If password fields have values, update password in database
        if (newPw || confirmPw) {
          if (!newPw || !confirmPw) { 
            if (pwErr) {
              pwErr.textContent = 'Please fill both password fields.';
              pwErr.classList.remove('d-none');
            }
            return; 
          }
          if (newPw !== confirmPw) { 
            if (pwErr) {
              pwErr.textContent = 'Passwords do not match.';
              pwErr.classList.remove('d-none');
            }
            return; 
          }
          
          // Validate password strength
          if (!validatePasswordStrength(newPw)) {
            if (pwErr) {
              pwErr.textContent = 'Password must contain at least 8 characters, uppercase, lowercase, number, and special character.';
              pwErr.classList.remove('d-none');
            }
            return;
          }

          // Update password via API
          try {
            const formData = new FormData();
            formData.append('new_password', newPw);
            formData.append('confirm_password', confirmPw);

            const response = await fetch('update_staff_password.php', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (result.success) {
              newPwEl.value = '';
              confirmPwEl.value = '';
              newPwEl.disabled = true;
              confirmPwEl.disabled = true;
              passwordUpdated = true;
              showMsg('success', 'Password updated successfully!');
              
              // Exit edit mode if active
              if (editing) {
                editing = false;
                editBtn.textContent = 'Edit';
                contactInput.disabled = true;
                firstNameInput.disabled = true;
                middleNameInput.disabled = true;
                lastNameInput.disabled = true;
                suffixInput.disabled = true;
                genderSelect.disabled = true;
                civilStatusSelect.disabled = true;
              }
              
              setTimeout(function () { 
                msgEl.className = 'small mt-2 d-none'; 
                msgEl.textContent = ''; 
              }, 2000);
              return;
            } else {
              if (pwErr) {
                pwErr.textContent = result.message || 'Failed to update password.';
                pwErr.classList.remove('d-none');
              }
              return;
            }
          } catch (error) {
            console.error('Password update error:', error);
            if (pwErr) {
              pwErr.textContent = 'Error updating password. Please try again.';
              pwErr.classList.remove('d-none');
            }
            return;
          }
        }

        // Exit edit mode if active
        if (editing) {
          editing = false;
          editBtn.textContent = 'Edit';
          contactInput.disabled = true;
          firstNameInput.disabled = true;
          middleNameInput.disabled = true;
          lastNameInput.disabled = true;
          suffixInput.disabled = true;
          genderSelect.disabled = true;
          civilStatusSelect.disabled = true;
        }

        // Show success message based on what was updated
        if (profileUpdated && contactUpdated) {
          showMsg('success', 'Profile and contact number updated successfully.');
        } else if (profileUpdated) {
          showMsg('success', 'Profile updated successfully.');
        } else if (contactUpdated) {
          showMsg('success', 'Contact number updated successfully.');
        } else {
          showMsg('success', 'Changes saved successfully.');
        }
        setTimeout(function () { msgEl.className = 'small mt-2 d-none'; msgEl.textContent = ''; }, 1600);
      });
    });

    // Check if staff needs to change default password on page load
    async function checkDefaultPassword() {
      try {
        const response = await fetch('check_default_password.php', {
          method: 'GET',
          cache: 'no-store'
        });
        
        const result = await response.json();
        
        if (result.success && result.isDefaultPassword) {
          const modal = new bootstrap.Modal(document.getElementById('firstLoginPasswordModal'));
          modal.show();
        }
      } catch (error) {
        console.error('Error checking default password:', error);
      }
    }

    function validateFirstLoginPassword(password) {
      const rules = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };
      
      document.getElementById('firstLogin-rule-length').className = rules.length ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-uppercase').className = rules.uppercase ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-lowercase').className = rules.lowercase ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-number').className = rules.number ? 'text-success' : 'text-muted';
      document.getElementById('firstLogin-rule-special').className = rules.special ? 'text-success' : 'text-muted';
      
      return Object.values(rules).every(Boolean);
    }

    document.getElementById('firstLoginNewPassword')?.addEventListener('input', function() {
      if (this.value) {
        validateFirstLoginPassword(this.value);
      }
    });

    document.getElementById('firstLoginSubmitBtn')?.addEventListener('click', async function() {
      const oldPassword = document.getElementById('firstLoginOldPassword').value;
      const newPassword = document.getElementById('firstLoginNewPassword').value;
      const confirmPassword = document.getElementById('firstLoginConfirmPassword').value;
      const errorDiv = document.getElementById('firstLoginPasswordError');
      const successDiv = document.getElementById('firstLoginPasswordSuccess');
      const submitBtn = this;

      errorDiv.classList.add('d-none');
      successDiv.classList.add('d-none');

      if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.classList.remove('d-none');
        return;
      }

      if (!oldPassword) {
        errorDiv.textContent = 'Current password is required';
        errorDiv.classList.remove('d-none');
        return;
      }

      if (!validateFirstLoginPassword(newPassword)) {
        errorDiv.textContent = 'Password does not meet all requirements';
        errorDiv.classList.remove('d-none');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Changing...';

        const formData = new FormData();
        formData.append('old_password', oldPassword);
        formData.append('new_password', newPassword);

        const response = await fetch('change_first_login_password.php', {
          method: 'POST',
          body: formData,
          cache: 'no-store'
        });

        const result = await response.json();

        if (result.success) {
          successDiv.textContent = 'Password changed successfully! Refreshing...';
          successDiv.classList.remove('d-none');
          
          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          errorDiv.textContent = result.message || 'Failed to change password';
          errorDiv.classList.remove('d-none');
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
        }
      } catch (error) {
        console.error('Password change error:', error);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Change Password';
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      checkDefaultPassword();
    });

    // Staff logout functionality
    document.getElementById('staffLogoutBtn')?.addEventListener('click', async function() {
      try {
        const staffId = sessionStorage.getItem('staff_id');
        
        if (!staffId) {
          window.location.href = 'staff-login.html';
          return;
        }
        
        const formData = new FormData();
        formData.append('staff_id', staffId);
        
        const response = await fetch('log_logout.php', {
          method: 'POST',
          body: formData,
          cache: 'no-store'
        });
        
        const result = await response.json();
        
        if (result.success) {
          sessionStorage.clear();
          window.location.href = 'staff-login.html';
        } else {
          console.error('Logout logging failed:', result.error);
          sessionStorage.clear();
          window.location.href = 'staff-login.html';
        }
      } catch (error) {
        console.error('Logout error:', error);
        sessionStorage.clear();
        window.location.href = 'staff-login.html';
      }
    });
  </script>

</body>
</html>
